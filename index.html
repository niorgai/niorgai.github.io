<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"niorgai.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="Android | jianqiu&#39;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Jianqiu&#39;s blog">
<meta property="og:url" content="http://niorgai.github.io/index.html">
<meta property="og:site_name" content="Jianqiu&#39;s blog">
<meta property="og:description" content="Android | jianqiu&#39;s blog">
<meta property="og:locale">
<meta property="article:author" content="Jianqiu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://niorgai.github.io/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>
<title>Jianqiu's blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-59068424-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-59068424-1');
      }
    </script>



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jianqiu's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Learn More</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jianqiu</p>
  <div class="site-description" itemprop="description">Android | jianqiu's blog</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/niorgai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;niorgai" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2024/05/01/TransactionTooLargeException/Fix-Android-TransactionTooLargeException/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/01/TransactionTooLargeException/Fix-Android-TransactionTooLargeException/" class="post-title-link" itemprop="url">Fix-Android-TransactionTooLargeException</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-01 00:16:49 / Modified: 01:07:05" itemprop="dateCreated datePublished" datetime="2024-05-01T00:16:49+08:00">2024-05-01</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2024/05/01/TransactionTooLargeException/Fix-Android-TransactionTooLargeException/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/05/01/TransactionTooLargeException/Fix-Android-TransactionTooLargeException/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><img src="image/exception_document.png"></p>
<p><code>TransactionTooLargeException</code> 表示在 RPC 调用中传输的数据过大(超过 1MB), 导致 RPC 调用失败.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/guardian/toolargetool/blob/main/toolargetool/src/main/java/com/gu/toolargetool/TooLargeTool.kt">TooLargeTool</a> 是一款可以方便打开 Bundle 大小的工具, 可以借鉴里面的代码实现.</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>除了常见的 Bundle 传输数据过大导致 startActivity 失败外, 经常还见到另一个堆栈:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Caused by:</span><br><span class="line">	android.os.TransactionTooLargeException:data parcel size <span class="number">942884</span> bytes</span><br><span class="line">	android.os.BinderProxy.transactNative(Native Method)</span><br><span class="line">	android.os.BinderProxy.transact(BinderProxy.java:<span class="number">621</span>)</span><br><span class="line">	android.app.IActivityClientController$Stub$Proxy.activityStopped(IActivityClientController.java:<span class="number">1459</span>)</span><br><span class="line">	android.app.ActivityClient.activityStopped(ActivityClient.java:<span class="number">112</span>)				        android.app.servertransaction.PendingTransactionActions$StopInfo.run(PendingTransactionActions.java:<span class="number">135</span>)</span><br><span class="line">	android.os.Handler.handleCallback(Handler.java:<span class="number">958</span>)</span><br><span class="line">	android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>)</span><br><span class="line">	android.os.Looper.loopOnce(Looper.java:<span class="number">224</span>)</span><br><span class="line">	android.os.Looper.loop(Looper.java:<span class="number">318</span>)</span><br><span class="line">	android.app.ActivityThread.main(ActivityThread.java:<span class="number">8669</span>)</span><br><span class="line">	java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">561</span>)</span><br><span class="line">	com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">1013</span>)</span><br></pre></td></tr></table></figure>
<p>同时 App 为单 Activity 多 Fragment 架构</p>
<h3 id="复现路径"><a href="#复现路径" class="headerlink" title="复现路径"></a>复现路径</h3><p>我们找到了一个复现路径:</p>
<ol>
<li>在<strong>同一个Activity</strong>打开多个 Fragment, 尽量不少于 20 个</li>
<li>App 退后台</li>
<li>此时可以在 Logcat 看到 <code>TransactionTooLargeException</code></li>
</ol>
<h3 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h3><ol>
<li><p>查看代码, 退后台时会调用 Fragment 的 <code>onSaveInstanceState(Bundle)</code> , 这是用来保存状态的方法, 尝试在 Fragment 的 onSaveInstanceState 方法中打印 Bundle 的大小, 结果只有大概 1kb .</p>
</li>
<li><p>除了 Fragment 的 `onSaveInstanceState ,还有 Activity 的 onSaveInstanceState 方法, 打印出来. 两个 Fragment 大约有 100kb, 如果再开一个 Fragment, 还会增加 70kb. 以此类推, 大约16个 Fragment, 就会超过 1MB 的限制. 所以原因就是** Activity 调用 onSaveInstanceState 时 Bundle 太大了**.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">activity onSaveInstanceState: com.example.activity.MainActivity@7db60c7 size = Bundle62666159 contains <span class="number">5</span> keys and measures <span class="number">108.3</span> KB when serialized as a Parcel</span><br><span class="line"> * com.google.app_measurement.screen_service = <span class="number">0.2</span> KB</span><br><span class="line"> * android:viewHierarchyState = <span class="number">0.3</span> KB</span><br><span class="line"> * androidx.lifecycle.BundlableSavedStateRegistry.key = <span class="number">107.3</span> KB</span><br><span class="line"> * android:lastAutofillId = <span class="number">0.1</span> KB</span><br><span class="line"> * android:fragments = <span class="number">0.4</span> KB bundle size <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h3 id="Bundle-中什么东西占用了空间"><a href="#Bundle-中什么东西占用了空间" class="headerlink" title="Bundle 中什么东西占用了空间"></a>Bundle 中什么东西占用了空间</h3><p>通过查看源码和结合工具打印, Bundle 本质也是 Key-Value 的形式, 我们可以一层一层解析 Bundle 中的数据和大小.</p>
</li>
<li><p><code>androidx.lifecycle.BundlableSavedStateRegistry.key</code> 存放的是 Bundle, 里面占用大小最大的是 <code>android:support:fragments</code> 这个 key 存放的 Bundle.<br> 源码:</p>
<p><img src="image/BundlableSavedStateRegistry.png"></p>
<p>日志:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">androidx.lifecycle.BundlableSavedStateRegistry.key size = <span class="number">101</span> KB , map size <span class="number">5</span></span><br><span class="line">  key: androidx:appcompat size = <span class="number">4</span> B </span><br><span class="line">  key: android:support:lifecycle size = <span class="number">4</span> B </span><br><span class="line">  key: androidx.lifecycle.internal.SavedStateHandlesProvider size = <span class="number">4</span> B</span><br><span class="line">  key: android:support:activity-result size = <span class="number">7.4</span> KB bundle</span><br><span class="line">  key: android:support:fragments size = <span class="number">93</span> KB bundle map size <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>android:support:fragments</code> key 中存放的是 Bundle, 里面是每个 Fragment 的 FragmentState 对象.<br>源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">​``` FragmentManager</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentManager</span> <span class="keyword">implements</span> <span class="title">FragmentResultOwner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String SAVED_STATE_TAG = <span class="string">&quot;android:support:fragments&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到 android:support:fragments 的 key</span></span><br><span class="line">    SavedStateRegistry registry =</span><br><span class="line">        ((SavedStateRegistryOwner) mHost).getSavedStateRegistry();</span><br><span class="line">registry.registerSavedStateProvider(SAVED_STATE_TAG, () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> saveAllStateInternal();</span><br><span class="line">        &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到 fragment_ 的key</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String FRAGMENT_STATE_TAG = <span class="string">&quot;state&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String FRAGMENT_NAME_PREFIX = <span class="string">&quot;fragment_&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FragmentStore mFragmentStore = <span class="keyword">new</span> FragmentStore();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// saveAllStateInternal() 方法</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">Bundle <span class="title">saveAllStateInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// First save all active fragments.</span></span><br><span class="line">        ArrayList&lt;String&gt; active = mFragmentStore.saveActiveFragments();</span><br><span class="line">    </span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (FragmentState state : savedState) &#123;</span><br><span class="line">            Bundle fragmentBundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">            fragmentBundle.putParcelable(FRAGMENT_STATE_TAG, state);</span><br><span class="line">            bundle.putBundle(FRAGMENT_NAME_PREFIX + state.mWho, fragmentBundle);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> bundle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FragmentStore</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FragmentStore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, FragmentState&gt; mSavedState = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">ArrayList&lt;FragmentState&gt; <span class="title">getAllSavedState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(mSavedState.values());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android:support:fragments size = <span class="number">93</span> KB bundle map size <span class="number">3</span></span><br><span class="line">	key: fragment_cc246ae6-d05a-44c1-9a07-e6b6e466cd03 size = <span class="number">40</span> KB </span><br><span class="line">	key: fragment_98067ccf-09ad-415b-b937-bb79c097db81 size = <span class="number">52</span> KB</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>FragmentState 可以直接在源码中找到, 由于其他都是基础类型, 最大的怀疑对象只有 mSavedFragmentState.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentState</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String mClassName;</span><br><span class="line">    <span class="keyword">final</span> String mWho;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mFromLayout;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mFragmentId;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mContainerId;</span><br><span class="line">    <span class="keyword">final</span> String mTag;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mRetainInstance;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mRemoving;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mDetached;</span><br><span class="line">    <span class="keyword">final</span> Bundle mArguments;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mHidden;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mMaxLifecycleState;</span><br><span class="line"></span><br><span class="line">    Bundle mSavedFragmentState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试反射打印一下大小也能印证:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">name: mArguments              size <span class="number">4</span> B</span><br><span class="line">name: mClassName              size <span class="number">49</span> B</span><br><span class="line">name: mContainerId            size <span class="number">82</span> B</span><br><span class="line">name: mDetached               size <span class="number">48</span> B</span><br><span class="line">name: mFragmentId             size <span class="number">82</span> B</span><br><span class="line">name: mFromLayout             size <span class="number">48</span> B</span><br><span class="line">name: mHidden                 size <span class="number">48</span> B</span><br><span class="line">name: mMaxLifecycleState      size <span class="number">82</span> B</span><br><span class="line">name: mRemoving               size <span class="number">48</span> B</span><br><span class="line">name: mRetainInstance         size <span class="number">48</span> B</span><br><span class="line">name: mSavedFragmentState     size <span class="number">40</span> KB</span><br></pre></td></tr></table></figure>
</li>
<li><p>mSavedFragmentState 因为也是 Bundle, 可以打印里面的 value 的大小.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onSaveInstanceState of: Bundle121352603 contains <span class="number">6</span> keys and measures <span class="number">57.4</span> KB </span><br><span class="line">	* fragmentation_arg_container = <span class="number">0.1</span> KB</span><br><span class="line">	* android:support:fragments = <span class="number">16.3</span> KB</span><br><span class="line">	* fragmentation_invisible_when_leave = <span class="number">0.1</span> KB</span><br><span class="line">	* fragmentation_state_save_animator = <span class="number">0.2</span> KB</span><br><span class="line">	* androidx.lifecycle.BundlableSavedStateRegistry.key = <span class="number">0.2</span> KB</span><br><span class="line">	* android:view_state = <span class="number">40.5</span> KB</span><br></pre></td></tr></table></figure>
<p>源码可以看到 android:view_state 就是一个 SparseParcelableArray</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FragmentStateManager</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIEW_STATE_TAG = <span class="string">&quot;android:view_state&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> Bundle <span class="title">saveBasicState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Bundle result = <span class="keyword">new</span> Bundle();</span><br><span class="line">     <span class="comment">// Fragment 保存状态</span></span><br><span class="line">     mFragment.performSaveInstanceState(result);</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">if</span> (mFragment.mSavedViewState != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">             result = <span class="keyword">new</span> Bundle();</span><br><span class="line">         &#125;</span><br><span class="line">         result.putSparseParcelableArray(</span><br><span class="line">                 VIEW_STATE_TAG, mFragment.mSavedViewState);</span><br><span class="line">     &#125;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印 android:view_state , Array 中存放的数据比较多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line">index: <span class="number">9</span> value: CompoundButton.SavedState&#123;5d3a096 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">10</span> value: CompoundButton.SavedState&#123;d4417 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">11</span> value: CompoundButton.SavedState&#123;12f3004 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">12</span> value: CompoundButton.SavedState&#123;8d0d9ed checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">13</span> value: CompoundButton.SavedState&#123;da13022 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">14</span> value: CompoundButton.SavedState&#123;6980ab3 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">15</span> value: CompoundButton.SavedState&#123;b714870 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">16</span> value: CompoundButton.SavedState&#123;9ee27e9 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">17</span> value: CompoundButton.SavedState&#123;1c62c6e checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">18</span> value: CompoundButton.SavedState&#123;dfe9f0f checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">19</span> value: CompoundButton.SavedState&#123;e7a7b9c checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">20</span> value: CompoundButton.SavedState&#123;27859a5 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">21</span> value: CompoundButton.SavedState&#123;32ca17a checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">22</span> value: CompoundButton.SavedState&#123;1901d2b checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">23</span> value: CompoundButton.SavedState&#123;d81b588 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">24</span> value: CompoundButton.SavedState&#123;4b9eb21 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">25</span> value: CompoundButton.SavedState&#123;5535b46 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">26</span> value: CompoundButton.SavedState&#123;<span class="number">8716107</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">27</span> value: CompoundButton.SavedState&#123;640a234 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">28</span> value: CompoundButton.SavedState&#123;<span class="number">329185d</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">29</span> value: CompoundButton.SavedState&#123;2d9e5d2 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">30</span> value: CompoundButton.SavedState&#123;d3906a3 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">31</span> value: CompoundButton.SavedState&#123;65fada0 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">32</span> value: CompoundButton.SavedState&#123;763dd59 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">33</span> value: CompoundButton.SavedState&#123;ecc8d1e checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">34</span> value: CompoundButton.SavedState&#123;34b69ff checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">35</span> value: CompoundButton.SavedState&#123;ba203cc checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">36</span> value: CompoundButton.SavedState&#123;cebf615 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">37</span> value: CompoundButton.SavedState&#123;eb05d2a checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">38</span> value: CompoundButton.SavedState&#123;5f6a71b checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">39</span> value: CompoundButton.SavedState&#123;ad190b8 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">40</span> value: CompoundButton.SavedState&#123;ba2de91 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">41</span> value: CompoundButton.SavedState&#123;94f21f6 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">42</span> value: CompoundButton.SavedState&#123;d4e99f7 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">43</span> value: CompoundButton.SavedState&#123;96b0064 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">44</span> value: CompoundButton.SavedState&#123;e05d2cd checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">45</span> value: CompoundButton.SavedState&#123;<span class="number">6436782</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">46</span> value: CompoundButton.SavedState&#123;4c8de93 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">47</span> value: CompoundButton.SavedState&#123;609bed0 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">48</span> value: CompoundButton.SavedState&#123;f29cec9 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">49</span> value: CompoundButton.SavedState&#123;a4479ce checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">50</span> value: CompoundButton.SavedState&#123;f98d0ef checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">51</span> value: CompoundButton.SavedState&#123;b93f7fc checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">52</span> value: CompoundButton.SavedState&#123;c778e85 checked=<span class="keyword">true</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">53</span> value: CompoundButton.SavedState&#123;c3264da checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">54</span> value: CompoundButton.SavedState&#123;6cb8d0b checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">55</span> value: CompoundButton.SavedState&#123;b2697e8 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">56</span> value: CompoundButton.SavedState&#123;<span class="number">7278e01</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">57</span> value: CompoundButton.SavedState&#123;ee1f4a6 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">58</span> value: CompoundButton.SavedState&#123;d23eee7 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">59</span> value: CompoundButton.SavedState&#123;8c14a94 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">60</span> value: CompoundButton.SavedState&#123;<span class="number">17e093d</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">61</span> value: CompoundButton.SavedState&#123;ba8b532 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">62</span> value: CompoundButton.SavedState&#123;4b69283 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">63</span> value: CompoundButton.SavedState&#123;6b27c00 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">64</span> value: CompoundButton.SavedState&#123;3c6fc39 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">65</span> value: CompoundButton.SavedState&#123;9a8f27e checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">66</span> value: CompoundButton.SavedState&#123;245d3df checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">67</span> value: CompoundButton.SavedState&#123;bc3582c checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">68</span> value: CompoundButton.SavedState&#123;51222f5 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">69</span> value: CompoundButton.SavedState&#123;dddb88a checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">70</span> value: CompoundButton.SavedState&#123;a5dcefb checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">71</span> value: CompoundButton.SavedState&#123;23cb18 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">72</span> value: CompoundButton.SavedState&#123;3aef971 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">73</span> value: CompoundButton.SavedState&#123;fe6d356 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">74</span> value: CompoundButton.SavedState&#123;4305fd7 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">75</span> value: CompoundButton.SavedState&#123;d1680c4 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">76</span> value: CompoundButton.SavedState&#123;968bbad checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">77</span> value: CompoundButton.SavedState&#123;f94cee2 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">78</span> value: CompoundButton.SavedState&#123;e312273 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">79</span> value: CompoundButton.SavedState&#123;b5ce530 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">80</span> value: CompoundButton.SavedState&#123;78265a9 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">81</span> value: CompoundButton.SavedState&#123;734f72e checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">82</span> value: CompoundButton.SavedState&#123;7172cf checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">83</span> value: CompoundButton.SavedState&#123;c63245c checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">84</span> value: CompoundButton.SavedState&#123;672b365 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">85</span> value: CompoundButton.SavedState&#123;69d583a checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">86</span> value: CompoundButton.SavedState&#123;8bc6ceb checked=<span class="keyword">true</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">87</span> value: CompoundButton.SavedState&#123;a2c2a48 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">88</span> value: CompoundButton.SavedState&#123;<span class="number">56020e1</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">89</span> value: CompoundButton.SavedState&#123;2f8be06 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">90</span> value: CompoundButton.SavedState&#123;c72ecc7 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">91</span> value: CompoundButton.SavedState&#123;9fda2f4 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">92</span> value: CompoundButton.SavedState&#123;55cea1d checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">93</span> value: CompoundButton.SavedState&#123;752b492 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">94</span> value: CompoundButton.SavedState&#123;c278e63 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">95</span> value: CompoundButton.SavedState&#123;dcbfa60 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">96</span> value: CompoundButton.SavedState&#123;c630b19 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">97</span> value: CompoundButton.SavedState&#123;1e387de checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">98</span> value: CompoundButton.SavedState&#123;4faadbf checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">99</span> value: CompoundButton.SavedState&#123;665c8c checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">100</span> value: CompoundButton.SavedState&#123;c103fd5 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">101</span> value: CompoundButton.SavedState&#123;a1c43ea checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">102</span> value: CompoundButton.SavedState&#123;bb666db checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">103</span> value: CompoundButton.SavedState&#123;862b578 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">104</span> value: CompoundButton.SavedState&#123;<span class="number">8220451</span> checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">105</span> value: CompoundButton.SavedState&#123;b72b4b6 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">106</span> value: CompoundButton.SavedState&#123;daa95b7 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">107</span> value: CompoundButton.SavedState&#123;dc9b124 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">108</span> value: CompoundButton.SavedState&#123;8b1948d checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">109</span> value: CompoundButton.SavedState&#123;ed6642 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">110</span> value: CompoundButton.SavedState&#123;348d653 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">111</span> value: CompoundButton.SavedState&#123;e82bb90 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">112</span> value: CompoundButton.SavedState&#123;42fec89 checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">113</span> value: CompoundButton.SavedState&#123;d6fa48e checked=<span class="keyword">false</span>&#125; size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">2131427585</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427586</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427590</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427593</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427598</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427802</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427846</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131427848</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428063</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428202</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428413</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428417</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428708</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428779</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428825</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428835</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428906</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428907</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428909</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428910</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131428911</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429227</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429229</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429267</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429275</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429278</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429311</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429320</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429738</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429739</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429740</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429898</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131429900</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430063</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430064</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430125</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430163</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430164</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430167</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430169</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430170</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430171</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430172</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430345</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430360</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430362</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430428</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430442</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430607</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430664</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430668</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430669</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430703</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430842</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430851</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430853</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430905</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430908</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430909</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131430910</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431039</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431050</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431070</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431386</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431572</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131431609</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131432508</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131432857</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131432984</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433180</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433181</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433191</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433196</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433204</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433205</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433790</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131433829</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434147</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434173</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434226</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434416</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434417</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434418</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434419</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434420</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434421</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434422</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434429</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434430</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434431</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434432</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434433</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434434</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434435</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434443</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434444</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434445</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434446</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434447</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434448</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434449</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434450</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434451</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434468</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434469</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434810</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434828</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434835</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434848</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131434968</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435021</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435050</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435129</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435286</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435294</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435455</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435466</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435526</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435880</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131435998</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436152</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436176</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436177</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436178</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436680</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436789</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436791</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436929</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131436931</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131437119</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131437153</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131437154</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131437155</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131437837</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131438026</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131438505</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131438874</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439071</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439124</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439161</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439162</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439163</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439165</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439190</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439210</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439213</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439246</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439648</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439692</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439741</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439790</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439839</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439840</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439962</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439964</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439970</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439973</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439974</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439975</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439976</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439977</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439978</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439979</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439980</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439981</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439982</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439983</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439984</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439985</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131439986</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440068</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440074</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440103</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440153</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440171</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440239</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440562</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131440686</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131441148</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131441578</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131441589</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131441992</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442003</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442375</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442378</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442382</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442383</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442598</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442726</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442795</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131443036</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131443037</span> value: android.view.AbsSavedState$<span class="number">1</span>@8084af size <span class="number">68</span> B</span><br><span class="line">index: <span class="number">2131442292</span> value: androidx.recyclerview.widget.RecyclerView$SavedState@203fa43 size <span class="number">316</span> B</span><br><span class="line">index: <span class="number">2131439968</span> value: androidx.recyclerview.widget.RecyclerView$SavedState<span class="meta">@a7dbafd</span> size <span class="number">316</span> B</span><br><span class="line">index: <span class="number">2131432685</span> value: androidx.recyclerview.widget.RecyclerView$SavedState<span class="meta">@d21c845</span> size <span class="number">316</span> B</span><br><span class="line">index: <span class="number">2131435295</span> value: androidx.recyclerview.widget.RecyclerView$SavedState<span class="meta">@f9ba3c1</span> size <span class="number">316</span> B</span><br><span class="line">index: <span class="number">2131435292</span> value: androidx.coordinatorlayout.widget.CoordinatorLayout$SavedState@8aa6ca8 size <span class="number">212</span> B</span><br><span class="line">index: <span class="number">2131429908</span> value: FragmentPager.SavedState&#123;d8000bc position=<span class="number">0</span>&#125; size <span class="number">176</span> B</span><br><span class="line">index: <span class="number">2131435148</span> value: FragmentPager.SavedState&#123;edabccb position=<span class="number">0</span>&#125; size <span class="number">176</span> B</span><br><span class="line">index: <span class="number">2131435999</span> value: FragmentPager.SavedState&#123;96fb766 position=<span class="number">0</span>&#125; size <span class="number">176</span> B</span><br><span class="line">index: <span class="number">2131440220</span> value: androidx.appcompat.widget.Toolbar$SavedState@32fe3f2 size <span class="number">172</span> B</span><br><span class="line">index: <span class="number">2131442599</span> value: HorizontalScrollView.SavedState&#123;4c428c0 scrollPosition=<span class="number">0</span>&#125; size <span class="number">128</span> B</span><br><span class="line">index: <span class="number">2131435051</span> value: HorizontalScrollView.SavedState&#123;cc57b9a scrollPosition=<span class="number">0</span>&#125; size <span class="number">128</span> B</span><br><span class="line">index: <span class="number">2131436299</span> value: android.widget.ProgressBar$SavedState<span class="meta">@d565aa7</span> size <span class="number">112</span> B</span><br><span class="line">index: <span class="number">2131436874</span> value: android.widget.ProgressBar$SavedState@18dab54 size <span class="number">112</span> B	</span><br></pre></td></tr></table></figure>
<p>一共 310 个对象, 全部加起来的话<br>105 * 212 + 192 * 68 + 4 * 316 + 212 + 3 * 176 + 172 + 128 * 2 + 112 * 2 = 37972 / 1024 = 37kb</p>
</li>
</ol>
<h3 id="原因总结"><a href="#原因总结" class="headerlink" title="原因总结"></a>原因总结</h3><ol>
<li>View 会保存自己的状态, 用于状态恢复.</li>
<li>Fragment 会保存所有 View 的状态(一个 Fragment 大约40k).</li>
<li>Activity 会保存 Activity 下 attach 的所有 Fragment 的状态.</li>
<li>如果 Activity 下嵌套 Fragment 过多, 保存状态时容易超过 1MB.</li>
</ol>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ol>
<li><p>不保存 Fragment 的 view 状态, 也不做恢复</p>
<p>即清除 Bundle 中数据</p>
<p>注意这里由于 Fragment 先调用 onSaveInstanceState 后保存 view_state, 所以我们要在 Activity 的 onSaveInstanceState 中清除 Bundle 中的数据</p>
<p><img src="image/fragment_save_order.png"></p>
<p>大概代码如下:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">BundleClipHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;BundleClipHelper&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Bundle 中这两个 key 比较占内存, 暂时只删除这两个 key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> BUNDLE_KEY_FRAGMENTS = <span class="string">&quot;android:support:fragments&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> BUNDLE_KEY_VIEWS = <span class="string">&quot;android:view_state&quot;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 待清理 Bundle 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> pendingClearBundleList = mutableListOf&lt;Bundle&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fragment 生命周期回调</span></span><br><span class="line"><span class="comment">     * 在 Fragment 调用 onSaveInstanceState 后记录需要清理的 Bundle</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> fragmentLifecycleCallbacks: FragmentManager.FragmentLifecycleCallbacks =</span><br><span class="line">        <span class="keyword">object</span> : FragmentManager.FragmentLifecycleCallbacks() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFragmentSaveInstanceState</span><span class="params">(fm: <span class="type">FragmentManager</span>, f: <span class="type">Fragment</span>, outState: <span class="type">Bundle</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">super</span>.onFragmentSaveInstanceState(fm, f, outState)</span><br><span class="line">                pendingClearBundleList.add(outState)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 fragment 生命周期回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(activity: <span class="type">FragmentActivity</span>?)</span></span> &#123;</span><br><span class="line">        activity?.supportFragmentManager?.registerFragmentLifecycleCallbacks(fragmentLifecycleCallbacks, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反注册 fragment 生命周期回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">unRegister</span><span class="params">(activity: <span class="type">FragmentActivity</span>?)</span></span> &#123;</span><br><span class="line">        activity?.supportFragmentManager?.unregisterFragmentLifecycleCallbacks(fragmentLifecycleCallbacks)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 裁剪 Bundle</span></span><br><span class="line"><span class="comment">     * 在 Activity 的 onSaveInstanceState 中调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clipBundle</span><span class="params">(activity: <span class="type">Activity</span>&lt;*&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (activity == <span class="literal">null</span> || !activity.needClipBundleWhenSaveInstanceState()) &#123;</span><br><span class="line">            pendingClearBundleList.clear()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pendingClearBundleList.isNotEmpty()) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;need clear fragment size: &quot;</span> + pendingClearBundleList.size)</span><br><span class="line">            pendingClearBundleList.forEach &#123;</span><br><span class="line">                it.remove(BUNDLE_KEY_FRAGMENTS)</span><br><span class="line">                it.remove(BUNDLE_KEY_VIEWS)</span><br><span class="line">            &#125;</span><br><span class="line">            pendingClearBundleList.clear()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存 Bundle 到内存, 并在 Activity 创建前替换, 缺点是不适用于首页(首页重启进程的话内存缓存也会丢失). 可以参考 <a target="_blank" rel="noopener" href="https://juejin.cn/post/7306388118914973734#heading-21">掘金</a></p>
</li>
<li><p>改为单 Activity 框架</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2022/10/14/Load-Url-With-Etag/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/14/Load-Url-With-Etag/" class="post-title-link" itemprop="url">Load url with etag by glide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-14 22:35:05" itemprop="dateCreated datePublished" datetime="2022-10-14T22:35:05+08:00">2022-10-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-10-15 00:15:32" itemprop="dateModified" datetime="2022-10-15T00:15:32+08:00">2022-10-15</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/10/14/Load-Url-With-Etag/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/10/14/Load-Url-With-Etag/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a>需求场景</h2><p>通过固定的 url 加载图片, 在 url 不变的情况下, 服务器可能会更新 url 对应的资源, 客户端需要能够及时检测到图片的更新并加载最新资源.</p>
<h4 id="服务器能够提供的交互"><a href="#服务器能够提供的交互" class="headerlink" title="服务器能够提供的交互"></a>服务器能够提供的交互</h4><ol>
<li><p>在正常情况下, 加载成功后, 返回 200 成功, Response Body 返回对应的图片资源, 同时 Response Header 中带上 etag 表示该 url 对应资源的特征值. 如:         </p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etag:&quot;bd6d0ff25778318b238ac530cb147247&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>后续的请求, Request Header 带上 <code>if-none-match</code> 给服务器检查是否更新, 如果图片资源未更新, 直接返回 304, 否则正常返回.</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Request Header</span><br><span class="line">if-none-match: &quot;bd6d0ff25778318b238ac530cb147247&quot;</span><br><span class="line">// </span><br><span class="line"></span><br><span class="line">// Response (未改变)</span><br><span class="line">Statue Code : 304</span><br><span class="line">// </span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h2><p>客户端需要</p>
<ol>
<li>本地缓存 url 对应的 etag, 同时在后续请求的时候带上. </li>
<li>加载图片的时候需要支持给 url 设置 Header</li>
<li>在图片加载成功后, 如果是远程 url 也需要读取 Response 的 Header.</li>
</ol>
<p>由于客户端一般都有通用的图片加载库, 所以 2,3 点需要图片库支持</p>
<h4 id="本地缓存-url-对应的-etag"><a href="#本地缓存-url-对应的-etag" class="headerlink" title="本地缓存 url 对应的 etag"></a>本地缓存 url 对应的 etag</h4><p>这个使用通用的 Key-Value 缓存都能实现, 可以用 SharedPrference, sqlite, MMKV 或 DataStore 都能实现, 我比较推荐用 MMKV 的形式, 最主要的特点是不需要切线程, 同时也是属于能够接受丢失的数据.</p>
<h4 id="图片库的支持"><a href="#图片库的支持" class="headerlink" title="图片库的支持"></a>图片库的支持</h4><p>这里以 Glide 举例, 常见的写法是 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Glide.with()</span><br><span class="line">    .asDrawable()</span><br><span class="line">    .load(url)</span><br><span class="line">    .signature(etag)</span><br><span class="line">    .into()</span><br></pre></td></tr></table></figure>


<ol>
<li>设置 Header, 这个比较简单, 可以通过自带的 GlideUrl 设置<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> header = LazyHeaders.Builder()</span><br><span class="line">               .addHeader(<span class="string">&quot;if-none-match&quot;</span>, etag)</span><br><span class="line">               .build()</span><br><span class="line"> <span class="keyword">val</span> glideUrl = GlideUrl(url, header)</span><br><span class="line"> Glide.load(glideUrl)</span><br></pre></td></tr></table></figure></li>
<li>Glide 取出 Http Response Header 中的 etag.<br> 我这边想到的办法比较麻烦:<ol>
<li>调整 Glide 的网络库实现为 OKHttp</li>
<li>给 Glide 设置 OKHttpClient 时添加自定义的 Interceptor , 然后就可以取出 Response 中的 etag.</li>
</ol>
</li>
</ol>
<p>但是这样有个问题, 就是 etag 无法与 Glide 的 Request 进行关联, 导致同一个 url 必定会有两次网络请求.</p>
<ol>
<li>第一次加载, 由于没有 etag 缓存, signature 传入的 etag 为 null. 此时 Glide 图片以 url 作为缓存 key.</li>
<li>第一次加载后, response 中取出 etag , 记录与 url 的映射关系.</li>
<li>第二次加载, signature 传入 url 对应的 etag, 由于该 etag 缓存 key 未找到对应的缓存图片, 所以又会发起一次网络请求.</li>
</ol>
<p>所以纯粹修改 Glide 图片库似乎不太好.</p>
<h4 id="先发起一次网络请求"><a href="#先发起一次网络请求" class="headerlink" title="先发起一次网络请求"></a>先发起一次网络请求</h4><p>由于图片正常返回时, Http Body 就是所需加载的图片资源 byte, 所以可以先发起一次网络请求, 拿到 etag 后, 设置 signature 并使用 <code>Glide.load(byte[])</code> 方法直接加载 Http 的 Body, 这样<strong>只有一次网络请求</strong>.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .build()</span><br><span class="line">client.newCall(request).enqueue(<span class="keyword">object</span>: Callback &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(call: <span class="type">Call</span>, e: <span class="type">IOException</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>, response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!response.isSuccessful) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> eTag = response.header(<span class="string">&quot;etag&quot;</span>) ?: url</span><br><span class="line">        Glide.with(getContext()).asDrawable()</span><br><span class="line">                .load(response.body?.bytes() ?: ByteArray(<span class="number">0</span>)))</span><br><span class="line">                .signature(ObjectKey(etag))</span><br><span class="line">                .into()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但是这样测试之后, 发现有新的问题, 即第二次请求虽然 etag 都匹配传入了, 但是依然发起了网络请求. 排查之后发现 <code>Glide.load(byte[])</code> 方法使用的 <code>ByteArrayLoader</code> 中定义的 DataSource 为 Local, 所以使用该方法就不会写入本地缓存, 第二次请求就不会命中缓存.</p>
<p>解决办法也比较简单, 可以仿照 <code>ByteArrayLoader</code> 写一个自定义的 Loader , 然后注册到 Glide 中, 注意替换 DataSource 为 Remote.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主要用于直接加载 HttpBody</span></span><br><span class="line"><span class="comment"> * 配合 ETag 使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ETagByteModel</span></span>(<span class="keyword">val</span> eTag: String, <span class="keyword">val</span> <span class="keyword">data</span>: ByteArray): Key &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDiskCacheKey</span><span class="params">(messageDigest: <span class="type">MessageDigest</span>)</span></span> &#123;</span><br><span class="line">        messageDigest.update(eTag.toByteArray(Key.CHARSET))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> === other) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (javaClass != other?.javaClass) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        other <span class="keyword">as</span> ETagByteModel</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (eTag != other.eTag) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hashCode</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> eTag.hashCode()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参考 ByteArrayLoader 实现</span></span><br><span class="line"><span class="comment"> * 调整 DataSource 为 remote, 这样可以走缓存逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ETagByteLoader</span>&lt;<span class="type">Data</span>&gt;</span>(<span class="keyword">val</span> converter: ByteArrayLoader.Converter&lt;Data&gt;) : ModelLoader&lt;ETagByteModel, Data&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">buildLoadData</span><span class="params">(model: <span class="type">ETagByteModel</span>, width: <span class="type">Int</span>, height: <span class="type">Int</span>, options: <span class="type">Options</span>)</span></span>: ModelLoader.LoadData&lt;Data&gt;? &#123;</span><br><span class="line">        <span class="keyword">return</span> ModelLoader.LoadData(model, Fetcher(model.<span class="keyword">data</span>, converter))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handles</span><span class="params">(model: <span class="type">ETagByteModel</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Fetcher</span>&lt;<span class="type">Data</span>&gt;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model We really ought to copy the model, but doing so can be hugely expensive and/or</span></span><br><span class="line"><span class="comment">     * lead to OOMs. In practice it&#x27;s unlikely that users would pass an array into Glide and</span></span><br><span class="line"><span class="comment">     * then mutate it.</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">internal</span> <span class="keyword">constructor</span>(<span class="keyword">private</span> <span class="keyword">val</span> model: ByteArray, <span class="keyword">private</span> <span class="keyword">val</span> converter: ByteArrayLoader.Converter&lt;Data&gt;) : DataFetcher&lt;Data&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loadData</span><span class="params">(priority: <span class="type">Priority</span>, callback: <span class="type">DataFetcher</span>.<span class="type">DataCallback</span>&lt;<span class="type">in</span> <span class="type">Data</span>&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> result = converter.convert(model)</span><br><span class="line">            callback.onDataReady(result)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cleanup</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// Do nothing.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// Do nothing.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDataClass</span><span class="params">()</span></span>: Class&lt;Data&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> converter.dataClass</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDataSource</span><span class="params">()</span></span>: DataSource &#123;</span><br><span class="line">          <span class="comment">// 注意 DataSource 的值</span></span><br><span class="line">            <span class="keyword">return</span> DataSource.REMOTE</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对应 InputStream 解析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamFactory</span> : <span class="type">ModelLoaderFactory</span>&lt;<span class="type">ETagByteModel, InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">build</span><span class="params">(multiFactory: <span class="type">MultiModelLoaderFactory</span>)</span></span>: ModelLoader&lt;ETagByteModel, InputStream&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> ETagByteLoader&lt;InputStream&gt;(</span><br><span class="line">                <span class="keyword">object</span> : ByteArrayLoader.Converter&lt;InputStream&gt; &#123;</span><br><span class="line">                    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">convert</span><span class="params">(model: <span class="type">ByteArray</span>?)</span></span>: InputStream &#123;</span><br><span class="line">                        <span class="keyword">return</span> ByteArrayInputStream(model)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDataClass</span><span class="params">()</span></span>: Class&lt;InputStream&gt; &#123;</span><br><span class="line">                        <span class="keyword">return</span> InputStream::<span class="keyword">class</span>.java</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">teardown</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Do nothing.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后注册到 Glide</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlideModule</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EtagGlideModule</span> <span class="keyword">extends</span> <span class="title">LibraryGlideModule</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponents</span><span class="params">(Context context, Glide glide, Registry registry)</span> </span>&#123;</span><br><span class="line">      registry.replace(ETagByteModel.class, InputStream.class, <span class="keyword">new</span> StreamFactory());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后加载的时候调用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> eTag = response.header(<span class="string">&quot;etag&quot;</span>) ?: url</span><br><span class="line">Glide.with(getContext()).asDrawable()</span><br><span class="line">        .load(EtagByteModel(etag, response.body?.bytes() ?: ByteArray(<span class="number">0</span>)))</span><br><span class="line">        .signature(ObjectKey(etag))</span><br><span class="line">        .into()</span><br></pre></td></tr></table></figure>

<p>这样即可以实现 etag 更新, 也可以利用到 Glide 的缓存, 对项目修改比较小.</p>
<h2 id="最终流程"><a href="#最终流程" class="headerlink" title="最终流程"></a>最终流程</h2><ol>
<li>首先检查是否有 url 对应的 etag 缓存<ul>
<li>如果没有缓存, 先发起一次网络请求, 成功之后利用 Glide 设置 signature 加载 http body.</li>
<li>如果有缓存<ol>
<li>先通过Glide 设置 signature 加载 url</li>
<li>在 Glide 的成功回调里面带上 if-none-match 的 Header 发起网络请求, 用于检查服务器是否更新了图片.</li>
</ol>
</li>
</ul>
</li>
</ol>
<h2 id="预加载与缓存的坑"><a href="#预加载与缓存的坑" class="headerlink" title="预加载与缓存的坑"></a>预加载与缓存的坑</h2><p>如果使用 Glide 的 preload 方法并且缓存了 preload 返回的 Drawable, 需要注意 Drawable 中的 Bitmap 对象在 preload 完成后会释放掉, 此时 Bitmap 会被 Glide 回收后复用给其他请求.<br>如果自己缓存了该 Bitmap, 会导致两种结果:</p>
<ol>
<li>Bitmap 错误展示了其他地方请求的结果, 即展示的图片与实际的 url 对不上.</li>
<li>Bitmap 复用 Crash<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException</span><br><span class="line">Canvas: trying to use a recycled bitmap android.graphics.Bitmap@111bacc</span><br><span class="line">    android.graphics.BaseCanvas.throwIfCannotDraw(BaseCanvas.java:<span class="number">77</span>)</span><br><span class="line">    android.graphics.MiuiCanvas.throwIfCannotDraw(MiuiCanvas.java:<span class="number">329</span>)</span><br><span class="line">    android.graphics.RecordingCanvas.throwIfCannotDraw(RecordingCanvas.java:<span class="number">277</span>)</span><br><span class="line">    android.graphics.BaseRecordingCanvas.drawBitmap(BaseRecordingCanvas.java:<span class="number">88</span>)</span><br><span class="line">    android.graphics.drawable.BitmapDrawable.draw(BitmapDrawable.java:<span class="number">548</span>)</span><br><span class="line">    android.widget.ImageView.onDraw(ImageView.java:<span class="number">1434</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
解决办法是自己缓存的场景不要用 preload, preload 的实现也是 CustomTarget, 并且在 preload 成功后 clear 了资源. 所以我们使用 into CustomTarget 即可.</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.into(<span class="keyword">object</span>: CustomTarget&lt;Drawable&gt;() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceReady</span><span class="params">(resource: <span class="type">Drawable</span>, transition: <span class="type">Transition</span>&lt;<span class="type">in</span> <span class="type">Drawable</span>&gt;?)</span></span> &#123;</span><br><span class="line">			<span class="comment">// 保存 Drawable</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadCleared</span><span class="params">(placeholder: <span class="type">Drawable</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 释放 Drawable</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2021/01/14/Android-Dialog-Tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/01/14/Android-Dialog-Tips/" class="post-title-link" itemprop="url">Android Dialog Tips</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-14 12:15:20" itemprop="dateCreated datePublished" datetime="2021-01-14T12:15:20+08:00">2021-01-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-05-19 17:06:50" itemprop="dateModified" datetime="2022-05-19T17:06:50+08:00">2022-05-19</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/01/14/Android-Dialog-Tips/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/14/Android-Dialog-Tips/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Dialog 使用的常见坑.</p>
<ol>
<li>dismiss 错误堆栈</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException View=DecorView@984ba6d[MainActivity] not attached to window manager</span><br><span class="line">	android.view.WindowManagerGlobal.findViewLocked(WindowManagerGlobal.java:<span class="number">619</span>)</span><br><span class="line">	android.view.WindowManagerGlobal.removeView(WindowManagerGlobal.java:<span class="number">511</span>)</span><br><span class="line">	android.view.WindowManagerImpl.removeViewImmediate(WindowManagerImpl.java:<span class="number">200</span>)</span><br><span class="line">	android.app.Dialog.dismissDialog(Dialog.java:<span class="number">766</span>)</span><br></pre></td></tr></table></figure>

<p>这里查看堆栈是 DIalog dismiss 的堆栈, 但是一般看不到调用 dialog.dismiss 的业务堆栈.</p>
<p>主要是因为这种情况下一般是子线程调用了 dismiss, 但是 Dialog 的 dismiss 会有一个切线程的操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dismiss</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (Looper.myLooper() == mHandler.getLooper()) &#123;</span><br><span class="line">          dismissDialog();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mHandler.post(mDismissAction);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中 mHandler 对象是在 Dialog 创建的时候初始化的, 所以 Looper 也是和创建 Dialog 的时候的线程绑定的, 同时因为 Handler 是 private 的, 所以目前想到的 hook 方式是自己同步创建一个 Handler , 在调用 dismiss 时自己切线程, 这样就可以正确 try catch 这个 Exception.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDialog</span></span>(context: Context): Dialog(context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> handler = Handler()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dismiss</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Looper.myLooper() == handler.looper) &#123;</span><br><span class="line">            superDismiss()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handler.post &#123; superDismiss() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">superDismiss</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.dismiss()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="comment">// catch success</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2020/11/27/ViewCacheExtension-Usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/27/ViewCacheExtension-Usage/" class="post-title-link" itemprop="url">ViewCacheExtension-Usage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2020-11-27 19:21:07 / Modified: 19:46:14" itemprop="dateCreated datePublished" datetime="2020-11-27T19:21:07+08:00">2020-11-27</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/11/27/ViewCacheExtension-Usage/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/11/27/ViewCacheExtension-Usage/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>ViewCacheExtension</code> 作为 <code>RecyclerView</code> 中的开发者自定义缓存, 具有以下特点:</p>
<ol>
<li>只有从缓存中取, 没有从缓存中读.</li>
<li>接口需要返回 View.</li>
<li>接口返回的 View 必须绑定了 ViewHolder .</li>
</ol>
<p>就应用来说, 我觉得有两个合适的场景</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/11/27/ViewCacheExtension-Usage/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2019/06/28/Java-VM/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/28/Java-VM/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/" class="post-title-link" itemprop="url">Java内存区域</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-06-28 11:27:12" itemprop="dateCreated datePublished" datetime="2019-06-28T11:27:12+08:00">2019-06-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2019-07-03 22:56:04" itemprop="dateModified" datetime="2019-07-03T22:56:04+08:00">2019-07-03</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/06/28/Java-VM/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/28/Java-VM/Java内存区域/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>根据 “Java 虚拟机规范”, Java 虚拟机在执行 Java 程序的过程中会把它所管理的内存划分为若干个不同的数据区域.</p>
<p><img src="images/img_jvm_memory_runtime.jpg"></p>
<p>而其实一个 Java 程序可以理解为一个进程, 进程里面的资源共享即区分以下区域的私有和共享.</p>
<p><strong>私有</strong>: </p>
<ul>
<li>程序计数器: 当前线程所执行的字节码的行号指示器.</li>
<li>虚拟机栈(VM Stack): 每个方法在执行时会创建一个<strong>栈帧</strong>来存储局部变量表, 操作数栈, 动态链接, 方法出口等信息. 主要是局部变量表, 存储了各种基本数据类型和对象引用.</li>
<li>本地方法栈(Native Method Stack): 对于 Native 方法的存储.</li>
</ul>
<p><strong>共享</strong>:</p>
<ul>
<li>Java 堆: 几乎所有的对象示例都要在这里分配内存, 也是 GC 的主要管理区域.</li>
<li>方法区: 存储虚拟机加载的类信息, 常量, 静态变量, JIT 编译之后的代码.</li>
</ul>
<h2 id="回收"><a href="#回收" class="headerlink" title="回收"></a>回收</h2><p>GC 方案常见的是 <code>引用计数法</code> 和 <code>根搜索算法</code>.</p>
<ul>
<li><code>引用记数法</code>: 给对象添加一个引用计数器, 被引用时计数器 +1, 引用失效时计数器 -1. 如果任何时刻计数器都为0, 那就不可能再被使用, 就可以被回收. 因为引用计数法在循环引用时会导致对象无法回收, 所以目前被弃用了.</li>
<li><code>可达性算法</code>: 目前认为比较成熟的算法, 即从 GC Roots 的对象作为起点, 向下搜索对象, 走过的路径称为引用链, 如果某个对象到 GC Roots 之间没有任何引用链, 那认为这个对象是不可达的, 它就可以被回收.</li>
</ul>
<p>GC Roots 有以下几种:</p>
<ol>
<li>虚拟机栈(栈帧中的本地变量表)中引用的对象.</li>
<li>方法区中类静态属性引用的对象.</li>
<li>方法区中常量引用的对象.</li>
<li>本地方法栈中 JNI 引用的对象.</li>
</ol>
<h2 id="对象引用"><a href="#对象引用" class="headerlink" title="对象引用"></a>对象引用</h2><p>涉及到内存回收, Java中对对象的引用可以使用以下四种，分别为强引用，软引用，弱引用，虚引用。<br><a target="_blank" rel="noopener" href="http://mobile.51cto.com/abased-406998.htm">参考地址</a>.</p>
<ol>
<li>强引用（StrongReference）</li>
</ol>
<p>强引用是使用最普遍的引用，如果一个对象具有强引用，那垃圾回收器绝不会回收它。当内存空间不足，Java虚拟机宁愿抛出OutOfMemoryError错误，使程序异常终止，也不会靠随意回收具有强引用的对象来解决内存不足的问题。**(默认的引用方式)**</p>
<ol start="2">
<li>软引用（SoftReference）</li>
</ol>
<p>如果一个对象只具有软引用，则内存空间足够，垃圾回收器就不会回收它；如果内存空间不足了，就会回收这些对象的内存**(即不抛出OOM错误)**。只要垃圾回收器没有回收它，该对象就可以被程序使用。软引用可用来实现内存敏感的高速缓存（下文给出示例）。软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中.</p>
<ol start="3">
<li>弱引用（WeakReference）</li>
</ol>
<p>弱引用与软引用的区别在于：只具有弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。不过，由于垃圾回收器是一个优先级很低的线程，因此 不一定会很快发现那些只具有弱引用的对象。弱引用可以和一个引用队列（ReferenceQueue）联合使用，如果弱引用所引用的对象被垃圾回收，Java虚拟机就会把这个弱引用加入到与之关联的引用队列中。</p>
<ol start="4">
<li>虚引用（PhantomReference）</li>
</ol>
<p>“虚引用”顾名思义，就是形同虚设，与其他几种引用都不同，虚引用并不会决定对象的生命周期。如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收器回收。虚引用主要用来跟踪对象被垃圾回收器回收的活动。虚引用与软引用和弱引用的一个区别在于：虚引用必须和引用队列 （ReferenceQueue）联合使用。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之 关联的引用队列中。 使用虚引用只是为了能够在对象回收时收到通知.</p>
<h5 id="ReferenceQueue的用法-以PhantomReference为例-："><a href="#ReferenceQueue的用法-以PhantomReference为例-：" class="headerlink" title="ReferenceQueue的用法(以PhantomReference为例)："></a>ReferenceQueue的用法(以PhantomReference为例)：</h5><pre><code>ReferenceQueue queue = new ReferenceQueue (); 
PhantomReference pr = new PhantomReference (object, queue);</code></pre>
<p> 名字 | 引用方式 | GC是否回收 | 是否 OOM<br>     —    | — | — | —<br>     强引用 | 直接调用 | 否 | 是<br>     软引用 | .get | 看内存情况 | 否<br>     弱引用 | .get | 是 | 否<br>     虚引用 | null | 是 | 否</p>
<h2 id="回收-1"><a href="#回收-1" class="headerlink" title="回收"></a>回收</h2><h4 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h4><p>即回收算法分为”标记”和”清除”两个阶段, 先扫描一次标记所有需要回收的对象, 再扫描一次回收所有被标记地对象.</p>
<p>缺点:</p>
<ul>
<li>效率太低</li>
<li>会产生大量不连续地内存碎片, 这些碎片会导致无法给大内存对象分配内存.</li>
</ul>
<h4 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h4><p>将可用内存分为大小相等的两块, 每次只使用其中的一块. 回收时把存活地对象复制到另一块区域即可, 其他空间都可以清理掉.</p>
<p>缺点:</p>
<ul>
<li>可用内存直接变成一半了.</li>
</ul>
<h4 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h4><p>先扫描一次标记所有需要回收的对象, 再让所有的对象都向一端移动, 最后清理掉边界以外的内存.</p>
<h4 id="分代回收"><a href="#分代回收" class="headerlink" title="分代回收"></a>分代回收</h4><p>现在的商业虚拟机大部分都是分代回收算法, 分为新生代(young gen)和老生代(old gen), 其中 young gen 又分为 eden 区, from survior 和 to survior 区. 新生代的 GC 叫做 Minor GC, 老生代的 GC 叫做 Major GC / Full GC . 数据一开始会分配到 Eden 区(大对象直接进入 old gen), young gen 采用的是复制算法, 因为 young gen 的大部分数据都是回马上死亡的, 所以只需复制少部分存货的对象从 From survior 到 To survior.  当 young gen 的数据经历了几次 GC 后(默认15次), 它会从 young gen 移到 old gen. 而 old gen 采用的是标记-整理算法, 可以应用 old gen 中对象 100% 都存活的情况.</p>
<h4 id="GC-日志"><a href="#GC-日志" class="headerlink" title="GC 日志"></a>GC 日志</h4><p>33.125: [GC [DefNew: 3324K-&gt;152K(3712K), 0.0025925 secs] 3324K-&gt;152K(11904K), 0.0031680 secs]</p>
<ul>
<li>33.125: Java 虚拟机启动以来经过的秒数.</li>
<li>GC 开头: 区分 GC 区域, 像这里的 DefNew 是 Serial 收集器的新生代区域, 还有 Full GC 表示全部 GC.</li>
<li>3324K -&gt; 152K(3712K): GC 前该内存区域的可用容量 -&gt; GC 后该内存区域已使用容量(该内存区域总容量)</li>
<li>0.0025925 secs: 该区域 GC 所占用的时间.</li>
<li>3324K-&gt;152K(11904K): GC 前 Java 堆已使用容量 -&gt; GC 后 Java 堆已使用容量(Java 堆总容量)</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2019/01/20/WorkManager-Guide-Tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/20/WorkManager-Guide-Tips/" class="post-title-link" itemprop="url">WorkManager-Guide&Tips</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-01-20 18:16:00" itemprop="dateCreated datePublished" datetime="2019-01-20T18:16:00+08:00">2019-01-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2019-02-13 14:41:29" itemprop="dateModified" datetime="2019-02-13T14:41:29+08:00">2019-02-13</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/01/20/WorkManager-Guide-Tips/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/20/WorkManager-Guide-Tips/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WorkManager-Guide-amp-Tips"><a href="#WorkManager-Guide-amp-Tips" class="headerlink" title="WorkManager-Guide&amp;Tips"></a>WorkManager-Guide&amp;Tips</h1><p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/workmanager/">WorkManager</a> 为了方便运行一些<strong>不着急的</strong>、<strong>异步的</strong>的<strong>后台</strong>任务而诞生. 大部分情况下, 只需要定义好自己想做的任务, 交给 <code>WorkManager</code> 去执行, 剩下就不用管了.</p>
<p>注意一下, 同样是后台线程, <code>WorkManager</code> 的重点在于保证<strong>就算 App 关掉之后后台任务也能够被执行</strong>. 而那种可以随着 App 退出而关闭的后台任务, 还是更适合使用 <code>ThreadPools</code>.</p>
<h2 id="以前的实现方案"><a href="#以前的实现方案" class="headerlink" title="以前的实现方案"></a>以前的实现方案</h2><ol>
<li><p>Service: 这是最常见的需要后台运行的方案了. 对比来说, Service 有以下几个问题: </p>
<ul>
<li>可能会由于开发者的设置而疯狂运行, 这会导致手机电量被疯狂消耗. 对比之下 WorkManager 的同一个周期任务的最小间隔时间是15分钟.</li>
<li><code>targetSdkVersion</code> 为 26 及以上的时候, 在不被允许创建后台服务的情况下, <code>startService()</code> 会抛出 <code>IllegalStateException</code>. 对比之下 WorkManager 会按照设定选择合适的时间运行.</li>
</ul>
</li>
<li><p>JobScheduler: 这个最关键的就是只有 Android 5.0 以上才能使用, 其实 WorkManager 在 5.0 以上也是用这个实现的.</p>
</li>
<li><p>AlarmManager + BroadcastReceiver. 这个方案也是可以的, WorkManager 在 5.0 以下也是这样实现的, 只是封装了更好用的 API .</p>
</li>
</ol>
<p>如果对更好用的 WorkManager 感兴趣, 就可以继续往下看了. 大概的介绍顺序是:</p>
<ol>
<li>导入</li>
<li>一次性任务的使用</li>
<li>周期性任务的使用</li>
<li>任务如何取消</li>
<li>给任务加上约束条件</li>
<li>多个任务以特定顺序执行</li>
<li>相同任务的重复处理策略</li>
<li>任务的输入和输出</li>
<li>一些需要注意的点</li>
</ol>
<p><strong>以下代码都可以在 <a target="_blank" rel="noopener" href="https://github.com/niorgai/WorkManagerDemo">Demo</a> 中找到.</strong></p>
<h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><p>和其他 JetPack 的组件一样, 在 <strong>project</strong> 的 <code>build.gradle</code> 文件中添加 <code>google()</code> 源: </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <strong>module</strong> 的 <code>build.gradle</code> 中添加 <strong>WorkManager</strong> 的依赖:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> work_version = <span class="string">&quot;1.0.0-beta05&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Java 依赖版本</span></span><br><span class="line">    implementation <span class="string">&quot;android.arch.work:work-runtime:$work_version&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Kotlin 依赖版本, 和上面的依赖二选一即可</span></span><br><span class="line">    implementation <span class="string">&quot;android.arch.work:work-runtime-ktx:$work_version&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可选 RxJava2 支持</span></span><br><span class="line">    implementation <span class="string">&quot;android.arch.work:work-rxjava2:$work_version&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可选 测试支持</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;android.arch.work:work-testing:$work_version&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>使用起来就如上面所说, 首先你需要创建一个 <code>任务 (Worker) </code>, 然后丢给 <code>WorkManager</code>.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestWorker</span></span>(context: Context, params: WorkerParameters)</span><br><span class="line">    : Worker(context, params) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// 这里已经是后台线程了, 只需要实现自己的业务逻辑就好了</span></span><br><span class="line">		<span class="comment">// return Result.retry(); 重试</span></span><br><span class="line">		<span class="comment">// return Result.failure(); 不再重试</span></span><br><span class="line">    	<span class="keyword">return</span> Result.success()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWorker</span> <span class="keyword">extends</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestWorker</span><span class="params">(Context context, WorkerParameters params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里已经是后台线程了, 只需要实现自己的业务逻辑就好了</span></span><br><span class="line">        <span class="comment">// return Result.retry(); 重试</span></span><br><span class="line">        <span class="comment">// return Result.failure(); 不再重试</span></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>Worker</code> 里面只声明要实现的任务, 其他的约束条件要在 <code>WorkRequest</code> 中设置, 把 <code>Worker</code> 变成 <code>WorkRequest</code>. 再交给 <code>WorkManager</code> 去执行就好了.</p>
<h3 id="一次性任务"><a href="#一次性任务" class="headerlink" title="一次性任务"></a>一次性任务</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line"><span class="keyword">val</span> oneTimeWorker = OneTimeWorkRequest.Builder(TestWorker::<span class="keyword">class</span>.java).build()</span><br><span class="line">WorkManager.getInstance().enqueue(oneTimeWorker)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">OneTimeWorkRequest oneTimeWorker =</span><br><span class="line">        <span class="keyword">new</span> OneTimeWorkRequest.Builder(TestWorker.class).build();</span><br><span class="line">WorkManager.getInstance().enqueue(oneTimeWorker);</span><br></pre></td></tr></table></figure>

<p>就是这么简单, 接下来 Worker 就会在后台线程运行了. </p>
<h3 id="周期性任务"><a href="#周期性任务" class="headerlink" title="周期性任务"></a>周期性任务</h3><p>周期性任务需要更加慎重一点. 开启之后如果不注意, 大部分情况下就会一直运行, 这可能带来很不好的用户体验.</p>
<p>设置周期性任务的时候, 需要设置 <code>repeatInterval(重复区间)</code> 和 <code>flexInterval(弹性区间)</code> 参数, 配合注释说明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[  弹性区间外  |  弹性区间内 (flex Interval) ][  弹性区间外  |  弹性区间内 (flex Interval) ]...</span><br><span class="line">[  任务不运行  |          任务可运行         ][  任务不运行  |          任务可运行         ]...</span><br><span class="line">\_________________________________________/\________________________________________/...</span><br><span class="line">       第一个区间 (repeat Interval)                 第二个区间 (repeat Interval)        ...(repeat)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>repeatInterval</code> 最小值是15分钟, 而 <code>flexInterval</code> 的最小值是5分钟, 如果 <code>flexInterval</code> 大于 <code>repeatInterval</code>, 也会被修改到和 <code>repeatInterval</code> 一样的值.</p>
<h3 id="取消任务"><a href="#取消任务" class="headerlink" title="取消任务"></a>取消任务</h3><p>但是从 API 可以看到, WorkManager 是将这个 Worker 入队了, 那既然是以队列维护的异步操作, 肯定会有重复的问题. WorkManager 默认的操作是遇到一样的 Worker 时, 新 Worker 会等旧 Worker 运行完再运行, 即顺序执行.</p>
<p>不过大部分情况下这都不是我们想要的模式, 所以在运行前最好取消相同的任务. 每个 <code>Worker</code> 都有一个唯一标识 UUID, 同时在构建 <code>WorkRequest</code> 的时候还可以添加任意个 Tag, 通过这两个标识都可以取消任务.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line"><span class="comment">// UUID 方式</span></span><br><span class="line"><span class="keyword">val</span> workId: UUID = oneTimeWorker.getId()</span><br><span class="line">WorkManager.getInstance().cancelWorkById(workId)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tag 方式</span></span><br><span class="line"><span class="keyword">val</span> oneTimeWorker = OneTimeWorkRequest.Builder(TestWorker::<span class="keyword">class</span>.java)</span><br><span class="line">    .addTag(<span class="string">&quot;myTag&quot;</span>)</span><br><span class="line">    .build()</span><br><span class="line">WorkManager.getInstance().cancelAllWorkByTag(<span class="string">&quot;myTag&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="comment">// UUID 方式</span></span><br><span class="line">UUID workId = oneTimeWorker.getId();</span><br><span class="line">WorkManager.getInstance().cancelWorkById(workId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tag 方式</span></span><br><span class="line">OneTimeWorkRequest myTask = <span class="keyword">new</span> OneTimeWorkRequest.Builder(TestWorker.class)</span><br><span class="line">    .addTag(<span class="string">&quot;myTag&quot;</span>)</span><br><span class="line">    .build()</span><br><span class="line">WorkManager.getInstance().cancelAllWorkByTag(<span class="string">&quot;myTag&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>取消相同的任务已经避免了系统资源不必要的消耗, 不过为了防止 API 的滥用, 还推荐给任务加上一些约束条件, 方便任务在系统资源没那么紧张的时候再执行:</p>
<h2 id="加上约束"><a href="#加上约束" class="headerlink" title="加上约束"></a>加上约束</h2><p>所有的约束 <code>Constraints</code> 都是由 <code>Constraints.Builder()</code> 来创建的, Builder 提供了以下的约束方式:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line"><span class="comment">// 设置网络类型</span></span><br><span class="line">setRequiredNetworkType(networkType: NetworkType)</span><br><span class="line"><span class="comment">// 是否运行时电量不要太低</span></span><br><span class="line">setRequiresBatteryNotLow(requiresBatteryNotLow: <span class="built_in">Boolean</span>)</span><br><span class="line"><span class="comment">// 是否在充电时才运行</span></span><br><span class="line">setRequiresCharging(requiresCharging: <span class="built_in">Boolean</span>)</span><br><span class="line"><span class="comment">// 是否不太剩余存储空间过低时运行</span></span><br><span class="line">setRequiresStorageNotLow(requiresStorageNotLow: <span class="built_in">Boolean</span>)</span><br><span class="line"><span class="comment">// 是否在设备空闲时运行, 这个最低版本是 23</span></span><br><span class="line">setRequiresDeviceIdle(requiresDeviceIdle: <span class="built_in">Boolean</span>)</span><br><span class="line"><span class="comment">// 监听一个本地的 Uri, 第二个参数是否监听 Uri 的子节点. 在 Uri 的内容改变时运行任务, 最低版本是 24</span></span><br><span class="line">addContentUriTrigger(uri: Uri, triggerForDescendants: <span class="built_in">Boolean</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="comment">// 设置网络类型</span></span><br><span class="line">setRequiredNetworkType(NetworkType networkType)</span><br><span class="line"><span class="comment">// 是否运行时电量不要太低</span></span><br><span class="line">setRequiresBatteryNotLow(<span class="keyword">boolean</span> requiresBatteryNotLow)</span><br><span class="line"><span class="comment">// 是否在充电时才运行</span></span><br><span class="line">setRequiresStorageNotLow(<span class="keyword">boolean</span> requiresStorageNotLow)</span><br><span class="line"><span class="comment">// 是否不太剩余存储空间过低时运行</span></span><br><span class="line">setRequiresStorageNotLow(requiresStorageNotLow: Boolean)</span><br><span class="line"><span class="comment">// 是否在设备空闲时运行, 这个最低版本是 23</span></span><br><span class="line">setRequiresDeviceIdle(<span class="keyword">boolean</span> requiresDeviceIdle)</span><br><span class="line"><span class="comment">// 监听一个本地的 Uri, 第二个参数是否监听 Uri 的子节点. 在 Uri 的内容改变时运行任务, 最低版本是 24</span></span><br><span class="line">addContentUriTrigger(Uri uri, <span class="keyword">boolean</span> triggerForDescendants)</span><br></pre></td></tr></table></figure>

<h2 id="多个任务的执行顺序"><a href="#多个任务的执行顺序" class="headerlink" title="多个任务的执行顺序"></a>多个任务的执行顺序</h2><p>WorkManager 提供了相应的 API 使任务可以使一个或多个 <code>OneTimeWorkerRequest</code> 按某个顺序执行.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A, B, C 就会按顺序执行, 如果全部返回成功或者某一个返回失败, 那该任务链就会结束.</span></span><br><span class="line">WorkManager.getInstance()</span><br><span class="line">    .beginWith(workA)</span><br><span class="line">    .then(workB)</span><br><span class="line">    .then(workC)</span><br><span class="line">    .enqueue()</span><br><span class="line"></span><br><span class="line"><span class="comment">// A, B 一起运行, 虽然这2个的开始顺序不定, 但是 C 一定是在这2个运行后才运行.</span></span><br><span class="line">WorkManager.getInstance()</span><br><span class="line">    .beginWith(Arrays.asList(workA, workB))</span><br><span class="line">    .then(workC)</span><br><span class="line">    .enqueue()</span><br><span class="line">    </span><br><span class="line"><span class="comment">// B 一定会在 A 后面运行, D 也一定会在 C 后面运行, 但是 AB 与 CD 这两条链的运行顺序不定, 但是 E 一定是在 B 和 D 都结束后才运行.</span></span><br><span class="line"><span class="keyword">val</span> chain1 = WorkManager.getInstance()</span><br><span class="line">    .beginWith(workA)</span><br><span class="line">    .then(workB)</span><br><span class="line"><span class="keyword">val</span> chain2 = WorkManager.getInstance()</span><br><span class="line">    .beginWith(workC)</span><br><span class="line">    .then(workD)</span><br><span class="line"><span class="keyword">val</span> chain3 = WorkContinuation</span><br><span class="line">    .combine(Arrays.asList(chain1, chain2))</span><br><span class="line">    .then(workE)</span><br><span class="line">chain3.enqueue()</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A, B, C 就会按顺序执行, 如果全部返回成功或者某一个返回失败, 那该任务链就会结束.</span></span><br><span class="line">WorkManager.getInstance()</span><br><span class="line">    .beginWith(workA)</span><br><span class="line">    .then(workB)</span><br><span class="line">    .then(workC)</span><br><span class="line">    .enqueue();</span><br><span class="line"></span><br><span class="line"><span class="comment">// A, B 一起运行, 虽然这2个的开始顺序不定, 但是 C 一定是在这2个运行后才运行.</span></span><br><span class="line">WorkManager.getInstance()</span><br><span class="line">    .beginWith(Arrays.asList(workA, workB))</span><br><span class="line">    .then(workC)</span><br><span class="line">    .enqueue();</span><br><span class="line">    </span><br><span class="line"><span class="comment">// B 一定会在 A 后面运行, D 也一定会在 C 后面运行, 但是 AB 与 CD 这两条链的运行顺序不定, 但是 E 一定是在 B 和 D 都结束后才运行.</span></span><br><span class="line">WorkContinuation chain1 = WorkManager.getInstance()</span><br><span class="line">    .beginWith(workA)</span><br><span class="line">    .then(workB);</span><br><span class="line">WorkContinuation chain2 = WorkManager.getInstance()</span><br><span class="line">    .beginWith(workC)</span><br><span class="line">    .then(workD);</span><br><span class="line">WorkContinuation chain3 = WorkContinuation</span><br><span class="line">    .combine(Arrays.asList(chain1, chain2))</span><br><span class="line">    .then(workE);</span><br><span class="line">chain3.enqueue();</span><br></pre></td></tr></table></figure>
<h2 id="相同任务的重复策略"><a href="#相同任务的重复策略" class="headerlink" title="相同任务的重复策略"></a>相同任务的重复策略</h2><p>前面提到对于 Worker 来说, 可以通过 UUID 和 Tag 来保证其唯一性, 这样在需要的时候就可以避免任务重复执行. 但对于连续的任务链, 如果任务多了, 这样的方式会很繁琐. 于是, WorkerManager 也提供了相应的 API 来保证其唯一性.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line">beginUniqueWork(uniqueWorkName: String, existingWorkPolicy: ExistingWorkPolicy, work: OneTimeWorkRequest): WorkContinuation</span><br><span class="line"></span><br><span class="line">beginUniqueWork(uniqueWorkName: String, existingWorkPolicy: ExistingWorkPolicy, work: List&lt;OneTimeWorkRequest&gt;): WorkContinuation</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="function">WorkContinuation <span class="title">beginUniqueWork</span><span class="params">(String uniqueWorkName, ExistingWorkPolicy existingWorkPolicy, OneTimeWorkRequest work)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">WorkContinuation <span class="title">beginUniqueWork</span><span class="params">(String uniqueWorkName, ExistingWorkPolicy existingWorkPolicy, List&lt;OneTimeWorkRequest&gt; work)</span></span></span><br></pre></td></tr></table></figure>

<p>第一个参数就是这一个或者一系列 worker 的名字, 第二个参数就是重复时的操作, 有以下几种模式:</p>
<ul>
<li>ExistingWorkPolicy.APPEND : 如果上一个任务处于等待或者未完成的状态, 则把当前任务添加到其任务链的后面. 这样它就在上一个任务执行完后执行.</li>
<li>ExistingWorkPolicy.KEEP : 如果上一个任务处于等待或者未完成的状态, 什么都不做(继续等上一个任务执行).</li>
<li>ExistingWorkPolicy.REPLACE : 如果上一个任务处于等待或者未完成的状态, 取消并删除上一个, 执行新的.</li>
</ul>
<h2 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h2><p>Worker 的输入输出是用 <code>Map&lt;String, Object&gt;</code> 来存储的, 用 <code>Data</code> 类封装了一层. 输出用 <code>LiveData</code> 来监听.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Kotlin</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建输入</span></span><br><span class="line"><span class="keyword">val</span> inputData = Data.Builder()</span><br><span class="line">                    .putInt(<span class="string">&quot;KEY_FIRST&quot;</span>, firstNumber)</span><br><span class="line">                    .putInt(<span class="string">&quot;KEY_SECOND&quot;</span>, secondNumber)</span><br><span class="line">                    .build()</span><br><span class="line"><span class="keyword">val</span> worker = OneTimeWorkRequestBuilder&lt;MathWorker&gt;()</span><br><span class="line">        .setInputData(inputData)</span><br><span class="line">        .build()</span><br><span class="line">WorkManager.getInstance().enqueue(worker)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker 类:</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlusWorker</span></span>(context: Context, workerParams: WorkerParameters) : Worker(context, workerParams) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="keyword">val</span> first = inputData.getInt(<span class="string">&quot;KEY_FIRST&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> second = inputData.getInt(<span class="string">&quot;KEY_SECOND&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> result = first + second <span class="comment">// 1 + 2 = 3</span></span><br><span class="line">        <span class="keyword">val</span> output = Data.Builder()</span><br><span class="line">                .putInt(<span class="string">&quot;KEY_RESULT&quot;</span>, result)</span><br><span class="line">                .build()</span><br><span class="line">        <span class="keyword">return</span> Result.success(output)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听返回</span></span><br><span class="line">WorkManager.getInstance().getWorkInfoByIdLiveData(worker.id)</span><br><span class="line">        .observe(<span class="keyword">this</span>, Observer &#123; info -&gt;</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="literal">null</span> &amp;&amp; info.state.isFinished) &#123;</span><br><span class="line">               	<span class="comment">// 获取返回结果, 应该是3</span></span><br><span class="line">                <span class="keyword">val</span> result = info.outputData.getInt(<span class="string">&quot;KEY_RESULT&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="comment">// 创建输入</span></span><br><span class="line">Data inputData = <span class="keyword">new</span> Data.Builder()</span><br><span class="line">    .putInt(<span class="string">&quot;KEY_FIRST&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .putInt(<span class="string">&quot;KEY_SECOND&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">OneTimeWorkRequest worker = <span class="keyword">new</span> OneTimeWorkRequest.Builder(PlusWorker.class)</span><br><span class="line">        .setInputData(inputData)</span><br><span class="line">        .build();</span><br><span class="line">WorkManager.getInstance().enqueue(worker);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker 类:</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlusWorker</span> <span class="keyword">extends</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PlusWorker</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> WorkerParameters workerParams)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, workerParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> first = getInputData().getInt(<span class="string">&quot;KEY_FIRST&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> second = getInputData().getInt(<span class="string">&quot;KEY_SECOND&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> result = first + second; <span class="comment">// 1 + 2 = 3</span></span><br><span class="line">        Data output = <span class="keyword">new</span> Data.Builder()</span><br><span class="line">                .putInt(<span class="string">&quot;KEY_RESULT&quot;</span>, result)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> Result.success(output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听返回</span></span><br><span class="line">WorkManager.getInstance().getWorkInfoByIdLiveData(worker.getId())</span><br><span class="line">    .observe(lifecycleOwner, info -&gt; &#123;</span><br><span class="line">         <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; info.getState().isFinished()) &#123;</span><br><span class="line">           <span class="comment">// 获取返回结果, 应该是3</span></span><br><span class="line">           <span class="keyword">int</span> result = info.getOutputData().getInt(KEY_RESULT, <span class="number">0</span>));</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="一些需要注意的地方"><a href="#一些需要注意的地方" class="headerlink" title="一些需要注意的地方"></a>一些需要注意的地方</h2><ul>
<li><p><code>WorkManager</code> 虽然在设计的时候是为了在 App 没运行的时候也能运行 Worker, 但是目前从 Google Issue Tracker 上的信息来看, 以下几种情况杀掉后任务的存活情况是这样的:</p>
<ol>
<li>从任务管理器(最近使用)关掉: 原生的 Android 上 Worker 仍然会运行, 但是在<a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/110745313">某些把这种操作当做强制停止的厂商</a> 或 <a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/113676489">一些中国厂商</a> 的机型上, Worker 要等到下次打开 App 才会运行.</li>
<li>重启手机 (Worker 运行中的状态): 重启后 Worker 会继续运行.</li>
<li>App 信息 -&gt; 强制关闭: Worker 会再下次打开 App 的时候运行.</li>
<li>重启手机 (App 被强制关闭了): Worker 会再下次打开 App 的时候运行.</li>
</ol>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2018/07/22/Count-Step-In-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/07/22/Count-Step-In-Android/" class="post-title-link" itemprop="url">Count-Step-In-Android</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-07-22 13:01:13" itemprop="dateCreated datePublished" datetime="2018-07-22T13:01:13+08:00">2018-07-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-07-26 19:43:45" itemprop="dateModified" datetime="2018-07-26T19:43:45+08:00">2018-07-26</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/07/22/Count-Step-In-Android/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/22/Count-Step-In-Android/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目前 Android 没有系统 Api 提供步数信息, 需要自己统计. 而系统能够提供的接口只有 Sensor 了.</p>
<h2 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h2><h4 id="方案-1"><a href="#方案-1" class="headerlink" title="方案 1"></a>方案 1</h4><p>如果为了兼容低版本, 可以从 <code>Sensor.TYPE_ACCELEROMETER(加速度传感器)</code> 开始. 这个传感器从 Android 1.5 (API 3) 就有了, 通过传感器的 x, y, z. 利用算法计算出相应步数. 特点是兼容性强, 缺点是高功耗, 需要进程常驻.</p>
<h4 id="方案-2"><a href="#方案-2" class="headerlink" title="方案 2:"></a>方案 2:</h4><p>从 Android 4.4 (API 14) 开始, 系统加入了新的传感器: <code>Sensor.TYPE_STEP_COUNTER</code> 和 <code>Sensor.TYPE_STEP_DETECTOR</code>.</p>
<ul>
<li><p>Sensor.TYPE_STEP_COUNTER</p>
<ol>
<li>当步数变化时, 返回从开机到现在的总步数, 重启清零.</li>
<li>这个传感器就是为低功耗设计的, 如果想持续监听步数, 不要反注册</li>
<li>用来实现健身类 App 统计步数.</li>
</ol>
</li>
<li><p>Sensor.TYPE_STEP_DETECTOR </p>
<ol>
<li>走了一步就返回一步, 返回值只有1.</li>
<li>方便用来统计某一段时间内的步数.</li>
</ol>
</li>
</ul>
<p>那么为了统计一天的步数, 当然是使用 方案2 中的 <code>Sensor.TYPE_STEP_COUNTER</code>. </p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><ol>
<li><p>注册传感器.</p>
</li>
<li><p><strong>当手机步数变化时</strong>, <code>SensorEventListener#onSensorChanged()</code> 返回手机从开机到现在的总步数:</p>
<ul>
<li><p>记录中是否有今日步数?</p>
</li>
<li><p>没有 -&gt; 今日步数为0</p>
</li>
<li><p>有 -&gt; </p>
<pre><code>  1. 如果传感器返回的步数 &lt; 记录的今日步数, 那么意味着重启了手机, 则</code></pre>
</li>
</ul>
</li>
</ol>
<pre><code>                今日步数 = 今日步数 + 传感器返回的步数.


        2. 如果不是大于, 那么正常计步即可.


                 今日步数 = 今日步数 + (传感器返回的步数 - 记录的今日步数)</code></pre>
<h4 id="补充逻辑"><a href="#补充逻辑" class="headerlink" title="补充逻辑"></a>补充逻辑</h4><p>因为每天第一次打开 App 时, 步数一定为0, 所以可以监听时间变化广播 <code>Intent.ACTION_DATE_CHANGED</code> , 每天打开一次 App 更新本日步数变化, 也可使用 <a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/workmanager">WorkManager</a>, 这样就算 App 没有开启也能更新.</p>
<h4 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h4><ol>
<li>如果 <code>SensorEventListener</code> 没有收到回调(需要 App 没有被杀并且手机步数有变化), 那么今天的步数就会计入第二天.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2018/01/23/Lifecycle-arch-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/23/Lifecycle-arch-summary/" class="post-title-link" itemprop="url">Lifecycle-arch-ViewModel</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2018-01-23 15:30:46 / Modified: 19:22:03" itemprop="dateCreated datePublished" datetime="2018-01-23T15:30:46+08:00">2018-01-23</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/01/23/Lifecycle-arch-summary/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/01/23/Lifecycle-arch-summary/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>距离 Google 发布 Lifecycle 组件已经有一段时间了, 特意尝鲜用了一下, 这里主要记录一下 ViewModel 组件的原理和功能.</p>
<h2 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/viewmodel.html">ViewModel</a></h2><h4 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h4><p>ViewModel 用来存储和管理 UI 相关的数据, 在 UI 重建时不需要重建其相应的 ViewModel, 也可以在不同的 Fragment 之间共享一个 ViewModel.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCleared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>它本身就是一个抽象类, 可以实现 onCleared() 方法做一些清理工作</p>
<h4 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h4><p>获取 ViewModel 的方法很简单:</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ViewModel viewModel = ViewModelProviders.of(context).get(ViewModel.class);</span><br></pre></td></tr></table></figure>
<p>通过这个方法去追踪实现即可, 实际代码不多, 就贴个实现过程吧.</p>
<p>context 传入 <code>Fragment</code> 或 <code>FragmentActivity</code>, 因为他们都可以添加 Fragment. 这里就以 FragmentActivity 为例来说明.</p>
<ol start="2">
<li>创建一个没有 view 的 <code>HolderFragment</code>, <code>HolderFragment</code> 中通过设置 <code>setRetainInstance(true);</code> 实现它在 Activity 重建时能够保存自己的实例</li>
<li><code>HolderFragment</code> 的 <code>ViewModelStores</code> 会维护一个 <code>HashMap&lt;String, ViewModel&gt;</code> 用于记录其实例化过的 ViewModel 对象, 并在 <code>HolderFragment</code> 的 <code>onDestroy()</code> 回调中执行 ViewModel 的 <code>onCleared()</code> 方法</li>
</ol>
<p>这里有一个关于生命周期的细节, 为了防止 Fragment 重复创建或者泄露, Google 对其做了一些保护:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;Activity, HolderFragment&gt; mNotCommittedActivityHolders = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>add Fragment 的流程(以 FragmentActivity 为例):</p>
<ol>
<li><p><code>Application</code> 注册 <code>ActivityLifecycleCallbacks</code>, 在 Activity <code>onDestroy()</code> 时从 mNotCommittedActivityHolders 中移除未 commit 的 <code>HolderFragment</code>.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">activity.getApplication().registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">           HolderFragment fragment = mNotCommittedActivityHolders.remove(activity);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>commit <code>HolderFragment</code> 到对应 Activity </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HolderFragment <span class="title">createHolderFragment</span><span class="params">(FragmentManager fragmentManager)</span> </span>&#123;</span><br><span class="line">       HolderFragment holder = <span class="keyword">new</span> HolderFragment();</span><br><span class="line">       fragmentManager.beginTransaction().add(holder, HOLDER_TAG).commitAllowingStateLoss();</span><br><span class="line">       <span class="keyword">return</span> holder;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 HolderFragment 的 <code>onCreate()</code> 生命周期中从 mNotCommittedActivityHolders 中移除自己</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">holderFragmentCreated</span><span class="params">(Fragment holderFragment)</span> </span>&#123;</span><br><span class="line">       Fragment parentFragment = holderFragment.getParentFragment();</span><br><span class="line">       <span class="keyword">if</span> (parentFragment != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mNotCommittedFragmentHolders.remove(parentFragment);</span><br><span class="line">           parentFragment.getFragmentManager().unregisterFragmentLifecycleCallbacks(</span><br><span class="line">                   mParentDestroyedCallback);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           mNotCommittedActivityHolders.remove(holderFragment.getActivity());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这样可以防止重复调用导致多次创建 HolderFragment, 也可以在 Fragment 创建后移除不必要的备份, 更可以防止内存泄露.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2018/01/18/App-Callback-Mark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/18/App-Callback-Mark/" class="post-title-link" itemprop="url">App-Callback-Mark</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-01-18 01:09:06" itemprop="dateCreated datePublished" datetime="2018-01-18T01:09:06+08:00">2018-01-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-01-19 17:51:18" itemprop="dateModified" datetime="2018-01-19T17:51:18+08:00">2018-01-19</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/01/18/App-Callback-Mark/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/01/18/App-Callback-Mark/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>App 之间回调是常有的事, 特别是一些提供第三方登录/第三方支付的 App, 更是需要提供调起, 登录/支付, 回调原 App 的功能. 在实现的过程中遇到一些问题, 所以记录一下.</p>
<p>接下来调起界面称为 <code>CallActivity</code>, 调起 App 称为 <code>Call App</code> , 被调起页面称为 <code>PayActivity</code>. 被调起 App 称为 <code>Pay App</code>.</p>
<h2 id="常见方案-startActivityForResult"><a href="#常见方案-startActivityForResult" class="headerlink" title="常见方案: startActivityForResult"></a>常见方案: startActivityForResult</h2><p>最常见的当然是 通过 <code>startActivityForResult()</code> 使用隐式 Intent 调起, 然后在 <code>onActivityResult()</code> 中捕捉回调并处理成功失败逻辑了. 这种方法大部分人都会, 说点遇到的问题吧:</p>
<ul>
<li><p>问题来了</p>
<ul>
<li>问题一:<ul>
<li>打开 <code>Pay Activity</code> 后可以切到后台, 再切回来, 这样做一方面安全性不够, 另一方面不符合支付工具的特性. 第三方应用调起支付应用后, 对用户的感觉不应该是完整的打开了一个应用, 而应该是仅仅启动了支付的一个功能, 切到后台后应该无法再切回该支付页面, 最近打开的应用页面也不该展示 Pay App.</li>
<li>在 <code>AndroidManifest.xml</code> 中加上 <code>android:excludeFromRecents=&quot;true&quot;</code></li>
</ul>
</li>
<li>问题二:<ul>
<li>支付成功后, 按 Home 键切到后台, 再切回 <code>Call App</code>, 这时候没有触发 <code>onActivityResult()</code></li>
<li>这是系统问题, 正常逻辑, 只能在 <code>onResume()</code> 里面查询后台是否成功.</li>
</ul>
</li>
<li>问题三:<ul>
<li>如果已经打开了 <code>Pay App</code>, 然后切到后台, 打开到 <code>Call App</code>, 调起 <code>Pay Activity</code> 后按返回键, 返回到 <code>Pay App</code> 的界面了.</li>
<li>需要指定 <code>PayActivity</code> 的 luanchMode 为 <code>singleInstance</code></li>
</ul>
</li>
</ul>
</li>
<li><p>大坑来了</p>
<p>  坑就在于这个 <code>singleInstance</code>, 在 Android 5.0 上一切正常, 但是在 Android 4.4 及以下版本, <code>Call Activity</code> 调用 <code>startActivityForResult()</code> 后, 直接回调了 <code>onActivityResult()</code>, 然后才打开 <code>Pay Activity</code>.</p>
<p>  为此我记录了一下不同 luanchMode 对 Android 4.4 及以下版本回调的影响.</p>
<p>  <strong>正常回调 -&gt; Y</strong></p>
<p>  <strong>直接回调 -&gt; N</strong></p>
<pre><code>   | Call Activity  | Standard | SingleTop | SingleTask | SingleInstance 
  :---: | :---:  | :---: | :---: | :---: | :---: 
  Pay Activity  |
  Standard | | Y | Y | Y | N 
  SingleTop | | Y | Y | Y | N 
  SingleTask | | N | N | N | N 
  SingleInstance | | N | N | N | N </code></pre>
</li>
<li><p>startActivityForResult 方案不可行</p>
<p>  对于 <code>startActivityForResult()</code> 来说, 想实现对 singleInstance 的回调是不可能了, 同时还有问题二也需要优化, 所以最好还是换个方案来执行.</p>
</li>
</ul>
<h2 id="透明中间页-广播方案"><a href="#透明中间页-广播方案" class="headerlink" title="透明中间页 + 广播方案"></a>透明中间页 + 广播方案</h2><p>之前版本由于已经发布, 需要兼容旧版本, 同时为了优化问题二, 考虑在接入 sdk 中提供一个中间页面 <code>Entry Activity</code>. 另外对于 singleInstance 的问题, 考虑用广播来替代.</p>
<p><code>Call Activity</code> -&gt; <code>Entry Activity</code> -&gt; <code>Pay Activity</code></p>
<ul>
<li><p>各页面功能如下:</p>
<p>  <code>Call Activity</code></p>
<ul>
<li><p>依旧执行 startActivityForResult 方法, sdk 内部直接调起 <code>Pay Activity</code> 改为调起透明 <code>Entry Activity</code>.</p>
</li>
<li><p>在 onActivityResult 中处理回调逻辑.</p>
<p><code>Entry Activity</code></p>
</li>
<li><p>设置 theme 为透明, 同时取消进入和退出的动画. 设置 luanchMode 为 singleTop</p>
</li>
<li><p>注册广播, 监听 <code>Pay Activity</code> 发来的支付成功的广播</p>
</li>
<li><p>直接通过 <code>startActivity</code> 调起 <code>PayActivity</code></p>
</li>
<li><p>在第二次进入 <code>onResume()</code> 时判断是否收到了支付成功的广播, 否则当做支付失败处理.</p>
</li>
<li><p>成功及支付都通过 <code>setResult()</code> 的方式回调</p>
<p><code>Pay Activity</code></p>
</li>
<li><p>支付成功使用广播通知.</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2017/12/07/AndroidTest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/07/AndroidTest/" class="post-title-link" itemprop="url">AndroidTest</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-12-07 20:43:40" itemprop="dateCreated datePublished" datetime="2017-12-07T20:43:40+08:00">2017-12-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-03-22 21:00:21" itemprop="dateModified" datetime="2018-03-22T21:00:21+08:00">2018-03-22</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/12/07/AndroidTest/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/12/07/AndroidTest/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Android 中单元测试并不常见, 这篇文章就我自己的知识范围来介绍:</p>
<h2 id="JUnit"><a href="#JUnit" class="headerlink" title="JUnit"></a>JUnit</h2><p>在学习 Java 时就知道这是一个用来给纯 Java 测试的工具, 在 Android 中一样使用, Android Studio 可以用快捷键 <code>cmd + enter</code> 为每个类自动创建测试类. 在测试类中, 一般使用 <code>Assert</code> 来断言每个条件的对错, 而 JUnit 的注解则为单元测试提供框架.</p>
<ul>
<li><p><code>@Test</code> </p>
<p>  定义测试单元(每个方法为一个单元用例), 接受参数有</p>
<ul>
<li><p>expected 预期会抛出某个异常, 不抛出则报错</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;? extends Throwable&gt; expected() <span class="keyword">default</span> None.class;</span><br></pre></td></tr></table></figure></li>
<li><p>timeout 超时</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> 0L</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>@Before</code> </p>
<p>  每个 Test 方法执行之前都会调用, 可以做预处理操作, 必须修饰 public 方法</p>
</li>
<li><p><code>@After</code></p>
<p>  每个 Test 方法执行之后都会调用, 可以做清理操作</p>
</li>
<li><p><code>@BeforeClass</code></p>
<p>  由于连续测试可能需要共享一个变量, 或者每个测试单元执行前都需要很长时间的准备工作, 可以把这些准备工作移到 BeforeClass 中, 该注解必须注解于一个 <strong>public static void</strong> 且<strong>没有参数</strong>的方法.</p>
</li>
<li><p><code>@AfterClass</code></p>
<p>  用于 @BeforeClass 的清理工作</p>
</li>
<li><p><code>@Ignore</code></p>
<p>  用于执行测试的时候忽略某个 @Test 单元</p>
</li>
<li><p><code>@Rule</code></p>
<p>  定义 <code>@Test</code> 单元执行时的逻辑, <code>org.junit.rules</code> 包定义了一些常用的 Rule 规则, 但我们也可以自定义 Rule.</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuleSample</span> <span class="keyword">implements</span> <span class="title">TestRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Statement <span class="title">apply</span><span class="params">(Statement base, Description description)</span> </span>&#123;</span><br><span class="line">           base.evaluate();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h2><p>Mock 即[模拟]的意思, 当某些类因为依赖太多等关系难以创造, 或者我们只需要一个类的对象时, Mock 便是一个很好的工具, 可以帮助我们隔离代码进行测试. 而 Mockito 便是一个 Android 常用的 Mock 工具类.</p>
<h4 id="模拟对象"><a href="#模拟对象" class="headerlink" title="模拟对象"></a>模拟对象</h4><p>Mockito 支持多种模拟对象方法.</p>
<ul>
<li><p><code>@Mock</code> 直接注解对象. 注解对象需要初始化, 可以有四种初始化方法.</p>
<ul>
<li><p>在 <code>@Before</code>  注解的初始化方法中使用<code>MockitoAnnotations.initMocks(this);</code> </p>
</li>
<li><p>使用自带的 <code>@Rule</code> 初始化</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span></span><br><span class="line">  	<span class="keyword">public</span> MockitoRule mockitoRule = MockitoJUnit.rule();</span><br></pre></td></tr></table></figure></li>
<li><p>使用 <code>@RunWith</code> 注解测试类.</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(MockitoJUnitRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>使用 <code>Mockito.mock()</code> 初始化对象.</p>
</li>
</ul>
</li>
<li><p><code>@InjectMock</code> 创建一个实例, 其余用 <code>@Mock</code> 或 <code>@Spy</code> 注解创建的 mock 对象将被注入到用该实例中.</p>
</li>
</ul>
<h4 id="设置桩"><a href="#设置桩" class="headerlink" title="设置桩"></a>设置桩</h4><p>Mockito 支持以下方法设置桩</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mockito.doXXX().when(XXX)</span><br><span class="line">Mockito.when(XXX).thenXXX()</span><br></pre></td></tr></table></figure>

<p>举个例子, 如果希望 <code>TextView</code> 在调用 <code>getText()</code> 时返回特定的内容, 可以使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mockito.when(mTextView.getText()).thenReturn(<span class="string">&quot;123);</span></span><br><span class="line"><span class="string">Mockito.doReturn(&quot;</span><span class="number">123</span><span class="string">&quot;).when(mTextView).getText();</span></span><br></pre></td></tr></table></figure>

<p>桩可以设置多次, 最终只会返回最后一次设置的值.</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>Mockito 支持以下方法来验证函数执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">verify</span><span class="params">(T mock)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">verify</span><span class="params">(T mock, VerificationMode mode)</span></span></span><br></pre></td></tr></table></figure>
<p>默认的 VerificationMode 即 <code>times(1)</code>, 即方法执行了一次, sdk 也提供了几种默认的验证模式实现, 如 <code>never()</code> , <code>atLeastOnce()</code> 等.</p>
<h4 id="参数匹配"><a href="#参数匹配" class="headerlink" title="参数匹配"></a>参数匹配</h4><p>为了模拟某些参数的输入, 可以匹配这些参数的输入, 并返回所需的值. <code>ArgumentMatchers.any()</code> 是一个比较常用的方法. </p>
<p>比如模拟 TextView 的 OnClickListener().</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Mockito.doAnswer(<span class="keyword">new</span> Answer() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        View.OnClickListener listener = invocation.getArgument(<span class="number">0</span>);</span><br><span class="line">        listener.onClick(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> listener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).when(mTextView).setOnClickListener(ArgumentMatchers.any(View.OnClickListener.class));</span><br></pre></td></tr></table></figure>

<h4 id="Spy"><a href="#Spy" class="headerlink" title="@Spy"></a>@Spy</h4><p>Mockito.spy() 返回的对象, 除非该方法已经有设置桩, 否则会调用该对象的真实方法. 可以用来改变对象特定方法的返回值, 而不改变对象本身. 注意 spy 不能 mock final 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List list = <span class="keyword">new</span> LinkedList();</span><br><span class="line">List spy = Mockito.spy(list);</span><br><span class="line">spy.add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">when(spy.size()).thenReturn(<span class="number">100</span>);</span><br><span class="line">spy.add(<span class="string">&quot;two&quot;</span>);</span><br><span class="line">System.out.println(spy.size());</span><br></pre></td></tr></table></figure>

<h2 id="JMockit"><a href="#JMockit" class="headerlink" title="JMockit"></a><a target="_blank" rel="noopener" href="https://github.com/jmockit/jmockit1">JMockit</a></h2><p>Mockito 的语法虽然比较简单易懂, 但它支持的功能还是不够多, 有一部分人是配合 PowerMock 一起使用, 但还有一个更强大的 Mock 工具值得使用.</p>
<h4 id="模拟对象-1"><a href="#模拟对象-1" class="headerlink" title="模拟对象"></a>模拟对象</h4><p>注意 <code>@RunWith</code> 注解初始化测试类.</p>
<ul>
<li><p>@Mocked 注解对象, 除了基本类型和数组对象, 其余所有都可以 mock, 会 mock 类中全部方法及其父类. 可以指定 <code>stubOutClassInitialization</code> 来决定 mock 对象时是否需要初始化静态变量, 某些 JNI 调用的静态变量在 mock 时初始化可能为 false, 这时候可以指定为 true 来跳过初始化.</p>
</li>
<li><p>@Injectable 仅 mock 指定的对象, 对于可以传入的对象, 使用 @Injectable 比 @Mock 更好</p>
</li>
<li><p>@Capturing mock 类及其子类, 也可以 mock 接口, 可以指定 maxInstances 来决定需要 mock 多少个对象.</p>
</li>
</ul>
<h4 id="常规使用"><a href="#常规使用" class="headerlink" title="常规使用"></a>常规使用</h4><p>JMockit 用法是 录制 - 执行 - 验证 (record - replay - verify).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//record</span></span><br><span class="line">    <span class="keyword">new</span> Expectations()&#123;&#123;</span><br><span class="line">        <span class="comment">//执行方法, 可以是构造函数</span></span><br><span class="line">        a.getName();</span><br><span class="line">        <span class="comment">//指定返回</span></span><br><span class="line">        result = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//run test code</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//verify</span></span><br><span class="line">    <span class="keyword">new</span> Verifications()&#123;&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="参数匹配-1"><a href="#参数匹配-1" class="headerlink" title="参数匹配"></a>参数匹配</h4><p>参数匹配有很多, 最宽松的是 anyXXX , 其次是 withXXX.<br>使用 <code>null</code> 时, 必须有一个 anyXXX 或者 withXXX .</p>
<h4 id="MockUp-API"><a href="#MockUp-API" class="headerlink" title="MockUp API"></a>MockUp API</h4><p>JMockit 我觉得 MockUp Api 特别强大, 几乎可以 Mock 所有的方法, 静态方法, 构造函数, 私有函数都可以, 这也是这个工具强大的地方.</p>
<p>比如有如下测试类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAnswer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么可以通过这样去 mock 对应的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> MockUp&lt;Test&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> $init(Invocation invocation, String name) &#123;</span><br><span class="line">            Test test = invocation.getInvokedInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Mocked Name&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">getAnswer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Mocked Answer&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="一些-Tip"><a href="#一些-Tip" class="headerlink" title="一些 Tip"></a>一些 Tip</h2><ul>
<li><p>如果只是某个方法需要某个 mock 过的变量, 可以在测试方法的入参中传入, 不需要写成全局变量.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="meta">@Mocked</span> TextView textView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jianqiu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-niorgai.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
