<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"niorgai.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="Android | jianqiu&#39;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Jianqiu&#39;s blog">
<meta property="og:url" content="http://niorgai.github.io/page/2/index.html">
<meta property="og:site_name" content="Jianqiu&#39;s blog">
<meta property="og:description" content="Android | jianqiu&#39;s blog">
<meta property="og:locale">
<meta property="article:author" content="Jianqiu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://niorgai.github.io/page/2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>
<title>Jianqiu's blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-59068424-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-59068424-1');
      }
    </script>



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jianqiu's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Learn More</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jianqiu</p>
  <div class="site-description" itemprop="description">Android | jianqiu's blog</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/niorgai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;niorgai" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2017/08/01/Android-Resource-Usage-Count/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/01/Android-Resource-Usage-Count/" class="post-title-link" itemprop="url">Android-Resource-Usage-Count</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-08-01 19:32:55" itemprop="dateCreated datePublished" datetime="2017-08-01T19:32:55+08:00">2017-08-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-08-21 18:39:12" itemprop="dateModified" datetime="2017-08-21T18:39:12+08:00">2017-08-21</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/08/01/Android-Resource-Usage-Count/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/01/Android-Resource-Usage-Count/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>插件地址: <a target="_blank" rel="noopener" href="https://plugins.jetbrains.com/plugin/9885-android-resource-usage-count">Jetbrains Plugin Page</a></p>
<p>Github 地址: <a target="_blank" rel="noopener" href="https://github.com/niorgai/Android-Resource-Usage-Count">Android-Resource-Usage-Count</a></p>
<h2 id="插件说明"><a href="#插件说明" class="headerlink" title="插件说明"></a>插件说明</h2><p>使用 <code>IntelliJ IDEA</code> 或者 <code>Android Studio</code> 打开 Android 项目的资源文件时, 会自动对文件中的资源标签统计其被引用次数, 展示在标签的前面, 统计结果会过滤 <code>build</code> 路径和 <code>bin</code> 路径的引用.</p>
<p><img src="http://7sbqys.com1.z0.glb.clouddn.com/resouce_count_plugin_example.jpeg"></p>
<ul>
<li><p>支持的标签: </p>
<ul>
<li><code>array</code></li>
<li><code>attr</code></li>
<li><code>bool</code></li>
<li><code>color</code></li>
<li><code>declare-styleable</code></li>
<li><code>dimen</code></li>
<li><code>drawable</code></li>
<li><code>eat-comment</code></li>
<li><code>fraction</code></li>
<li><code>integer</code></li>
<li><code>integer-array</code></li>
<li><code>item</code></li>
<li><code>plurals</code></li>
<li><code>string</code></li>
<li><code>string-array</code></li>
<li><code>style</code></li>
</ul>
</li>
<li><p>颜色说明:</p>
<ul>
<li>0 - 灰色</li>
<li>1 - 蓝色</li>
<li>其他 - 红色</li>
<li>可以在 <code>Preferences</code> - <code>Other Settings</code> - <code>Android Resource Usage Count</code> 中自定义颜色</li>
</ul>
</li>
</ul>
<h2 id="开发背景"><a href="#开发背景" class="headerlink" title="开发背景"></a>开发背景</h2><p>在 Android 项目开发过程中, 我一直都是把各种 <code>string</code> <code>color</code> 等资源定义在资源文件中, 再在代码中引用它. 如果有新的 <code>string</code> 或者 <code>color</code>, 我会先对比一下是否存在, 如果存在直接使用, 不存在才创建新的资源文件.</p>
<p>但是资源文件可能会改动, 经常产品需要改动一个 <code>string</code>, 或者设计需要改动一个 <code>color</code>, 我都要先手动在那个资源文件上右键 - Find Usage , 引用次数为1就直接改动这个标签内容, 否则要新建一个标签. 但是觉得每次都要搜索很繁琐, 所以才产生了开发这个插件的想法, 直接显示每个资源文件的引用次数.</p>
<h2 id="开发过程"><a href="#开发过程" class="headerlink" title="开发过程"></a>开发过程</h2><p>其实插件开发的文档还是比较少的, <a target="_blank" rel="noopener" href="http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started.html">官网</a> 提供的只是一个通用的开发过程, 按照文档你可以顺利创建项目, 然后就懵 B 了.</p>
<p>不过这里也是因为不同的插件需求不同, 所以还是建议想清楚自己想实现的功能和展示方式, 再多参考一下已有的系统功能怎么实现的, 已有的开源库怎么实现的, 最后当然是善用搜索.</p>
<p>说说我自己的开发过程, 我前期想实现的效果是</p>
<ol>
<li>打开资源文件时自动对每个标签统计引用次数. (功能)</li>
<li>在标签上以 hint 的形式展示其引用次数. (展示形式)</li>
</ol>
<p>先说功能这块: </p>
<ul>
<li><p>开发的时候我也是先从一个大多数例子都会提到的 <code>Action</code> 开始, 可是我怎么也找不到自己想要的 <code>Action</code> (打开某个资源文件). 最后只好随便建一个 <code>Action</code> 作为触发按钮, 先实现 FindUsage 的功能.</p>
</li>
<li><p>然后在实现 FindUsage 的功能时, 直接参考系统的 <code>FindUsageAction</code> 类, 还可以通过 debug 模式直接断点代码, 简直不能更爽. 根据 <code>FindUsageAction</code> 类的实现过程, 把核心代码复制到自己的工具类, 简单修改后就实现了功能. 这里要说明的是, <strong>尽量使用老版本的代码, 新版本的代码可能会在老版本上找不到方法而报错.</strong></p>
</li>
</ul>
<p>然后是展示形式:</p>
<ul>
<li>一开始我是希望像 <a target="_blank" rel="noopener" href="http://www.methodscount.com/plugins">Methods Count</a> 这样 <img src="http://www.methodscount.com/images/methods-count-plugin-1.png"><br>不过我找不到它是怎么实现的…尴尬</li>
<li>后面翻到了 <code>LineMarkerProvider </code> 这个类, 感觉这也是一种实现形式, 查看一下实现后也很简单, 最重要的是 <code>LineMarkerProvider </code> 是通过打开文件触发, 我还不用去找 <code>Action</code> 了.</li>
</ul>
<p>最后是设置界面:</p>
<ul>
<li>主要参考了 <a target="_blank" rel="noopener" href="http://www.jianshu.com/p/f017097e4b26">Android Studio插件开发实践–从创建到发布</a> 这篇文章的设置代码.</li>
</ul>
<h2 id="打包发布"><a href="#打包发布" class="headerlink" title="打包发布"></a>打包发布</h2><ul>
<li>打包主要按照 <a target="_blank" rel="noopener" href="http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/deploying_plugin.html">官网</a> 操作.</li>
<li>发布时, 在提交页面提交 jar 包后会进去编辑页面, 在 <code>Supported products</code> 模块去掉勾选 <code>Determine supported products by dependencies in plugin.xml</code>, 改为自定义支持所需平台就好. 我发布时发现 <code>plugin.xml</code> 无法解析 <code>com.intellij.modules.androidstudio</code>, 不知道是我的问题还是写法不对.</li>
</ul>
<h2 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h2><ol>
<li>插件是由 <code>LineMarkerProvider</code> 来实现的, 打开文件会自动触发搜索统计操作. 但是有时候统计结果显示比较慢, 如果没有显示, 可以尝试重新打开文件/编辑文件/等待.</li>
</ol>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>因为自己在开发插件方面的经历实在有限, 这个插件也是根据自己的需求而实现的. 一方面是想看看大家是否也会有这样的需求, 另一方面也是希望大家可以多帮忙看看代码, 有没有更好的实现或者插件本身有值得改进的地方, 博客通知不及时, 如果遇到问题多多去 <a target="_blank" rel="noopener" href="https://github.com/niorgai/Android-Resource-Usage-Count">Github</a> 上提 Issues 交流吧~</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2017/03/21/draw_system/Android-Draw-System/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/21/draw_system/Android-Draw-System/" class="post-title-link" itemprop="url">Android 绘制原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-21 20:23:27" itemprop="dateCreated datePublished" datetime="2017-03-21T20:23:27+08:00">2017-03-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2019-05-30 17:14:09" itemprop="dateModified" datetime="2019-05-30T17:14:09+08:00">2019-05-30</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/03/21/draw_system/Android-Draw-System/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/21/draw_system/Android-Draw-System/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="硬件分工"><a href="#硬件分工" class="headerlink" title="硬件分工"></a>硬件分工</h2><p>在计算机硬件中, 通常 CPU 用来处理数据, GPU 用来渲染数据. Android 系统也不例外, 绘制过程首先是 CPU 准备数据, 通过 Driver 层把数据交给 GPU 渲染. 其中 CPU 主要负责 Measure 、Layout 、Record 、Execute 的数据计算工作, GPU 负责 Rasterization（栅格化）、渲染. 由于图形 API 不允许 CPU 直接与 GPU 通信, 而是通过中间的一个图形驱动层（Graphics Driver）来连接这两部分. 图形驱动维护了一个队列, CPU 把 display list 添加到队列中, GPU 从这个队列取出数据进行绘制, 最终才在显示屏上显示出来.</p>
<p>那么无论是 CPU 准备的数据, 还是 GPU 渲染的数据, 都是以一帧一帧的形式来的. 我们所看到的界面也是有一帧一帧的图像连续显示而来. 对于人眼来说, 每秒钟看到60帧则比较流畅了, 即 FPS(Frame Per second) 为60, <code>1/60 = 0.01666667</code>, 即每 16ms 进行一次准备-渲染操作.</p>
<h2 id="系统变更历史"><a href="#系统变更历史" class="headerlink" title="系统变更历史"></a>系统变更历史</h2><p>在 Android 4.1 以前, 每一次渲染的流程可以用下图表示:</p>
<p><img src="image/android_draw_system_img_before.png"></p>
<p>横轴表示时间, 每条 VSync 线表示 16ms:</p>
<ol>
<li>第一个16ms中, 系统显示缓存块 A 中的第0帧, 同时 CPU 和 GPU 在缓存块 B 中准备第1帧.</li>
<li>第二个16ms中, 系统显示缓存块 B 中的第1帧, 但是此时 CPU 可能在处理其他事情, 所以在第二个16ms快结束时才开始在缓存块 A 中准备第2帧.</li>
<li>第三个16ms中, 由于第2帧还没准备好, 所以只能继续显示第1帧, 此时用户就会感知到卡顿.</li>
</ol>
<p>在 Android 4.1 版本中, 为了解决这些问题推出了 Project Butter, 主要引入 VSync, Triple Buffer和Choreographer.</p>
<ul>
<li><p>VSync : Vertical Synchronization, 即垂直同步, 可以理解为一种定时中断, GPU 和 CPU 在收到 VSync 信号时开始准备数据.</p>
<p>  引入 VSync 后的渲染流程如下:</p>
<p>  <img src="image/android_draw_system_with_vsync.png"></p>
<ol>
<li>这样每次收到 VSync 中断时, CPU 和 GPU 开始工作. <strong>只要 CPU 和 GPU 的 FPS 略高于 Display 的 FPS</strong>, 则每次都能在 16ms 之内准备好下一帧, 能够顺利显示. </li>
<li>如果 CPU 和 GPU 已经准备完毕, 只要没有收到 VSync 信号, 都不会进行渲染工作.</li>
</ol>
</li>
<li><p>Triple Buffer: 即3个缓存块. 在 Android 4.1 以前, 只有2个缓存块用于准备数据, 两个缓存块交替使用. 在引入 VSync 后, 如果 CPU 和 GPU 的 FPS 比 Display 的 FPS 低, 即不能在 16ms 内准备好数据, 会导致很严重的掉帧效果.</p>
<p>  <img src="image/android_draw_system_fps_small.png"></p>
<ol>
<li>在第一个16ms中, 系统显示缓存块A, CPU 和 GPU 在缓存块 B 中准备第1帧.</li>
<li>在第二个16ms中, 由于 GPU 还没有准备好, 所以只能继续显示缓存块 A 的内容, 用户感知到卡顿.</li>
</ol>
<p>为了解决这个问题, Android 4.1 引入第三个缓存块:</p>
<p><img src="image/android_draw_system_triple_buffer.png"></p>
<ol>
<li><p>在第一个16ms中, 系统显示缓存块A, CPU 和 GPU 在缓存块 B 中准备第1帧.</p>
</li>
<li><p>在第二个16ms中, 由于 GPU 还没有准备好, 所以只能继续显示缓存块 A 的内容, 用户感知到卡顿. 但此时 CPU 可以在缓存块 C 中准备数据.</p>
</li>
<li><p>正常显示不会再丢帧.</p>
<p>但是缓存块并不是越多越好, CPU 和 GPU 准备的数据最好在下一个 16ms 显示, 但是 Triple Buffer 中 CPU 准备的缓存块C, 在第四个 16ms 中才显示, 滞后了 16ms. 所以第三个缓存块主要是备用, 一般来说两个缓存块就够了.</p>
</li>
</ol>
</li>
<li><p>Choreographer: 译为舞蹈编排, 起到调度作用, 收到 VSync 信号时调用用户设置的回调函数, 回调类型有三种:</p>
<ul>
<li>CALLBACK_INPUT：优先级最高，和输入事件处理有关。</li>
<li>CALLBACK_ANIMATION：优先级其次，和Animation的处理有关。</li>
<li>CALLBACK_TRAVERSAL：优先级最低，和UI等控件绘制有关。</li>
</ul>
</li>
</ul>
<h4 id="invalidate-调用顺序"><a href="#invalidate-调用顺序" class="headerlink" title="invalidate() 调用顺序"></a>invalidate() 调用顺序</h4><ul>
<li>View.invalidate()</li>
<li>View.invalidateInternal() -&gt; 找到 dirty 区域并传给 ViewParent</li>
<li>ViewParent.invalidateChild -&gt; 接口, 由 ViewGroup 和 ViewRootImpl 实现</li>
<li>ViewGroup.invalidateChild -&gt; 向上递归调用 ViewParent.invalidateChildInParent, 直到 ViewRootImpl</li>
<li>ViewRootImpl.invalidateChildInParent -&gt; ViewRootImpl.scheduleTraversals</li>
<li>ViewRootImpl.scheduleTraversals -&gt; Choreographer.postCallback(Choreographer.TRAVERSAL)</li>
<li>Choreographer 调度到下一个 VSYNC 信号来时再回调. ViewRootImpl.doTraversal</li>
<li>ViewRootImpl.doTraversal -&gt; ViewRootImpl.performTraversals 开始绘制</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/11/17/Writing-Better-Adapters/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/11/17/Writing-Better-Adapters/" class="post-title-link" itemprop="url">Writing-Better-Adapters 译文及示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-11-17 21:59:26" itemprop="dateCreated datePublished" datetime="2016-11-17T21:59:26+08:00">2016-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2016-11-25 16:58:41" itemprop="dateModified" datetime="2016-11-25T16:58:41+08:00">2016-11-25</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/11/17/Writing-Better-Adapters/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/11/17/Writing-Better-Adapters/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这是一篇关于如何更好的编写 <code>RecyclerView</code> 的 <code>Adapter</code> 文章, 原文链接为 <a target="_blank" rel="noopener" href="https://medium.com/@dpreussler/writing-better-adapters-1b09758407d2#.oz9a26kb2">Writing-Better-Adapters</a> .</p>
<p>原文中的示例代码是用 <a target="_blank" rel="noopener" href="https://kotlinlang.org/">Kotlin</a> 编写的, 这里我会变成 <code>Java</code> 版本, 同时也会结合自己的理解做些改变. 所以建议大家还是看一遍原文.</p>
<hr>
<p>对于 Android 开发者来说, 实现 Adapter 是最频繁的工作之一. Adapter 是所有列表的基本, 而列表也是很多 App 的基本组成.</p>
<p>编写一个列表控件的方法大多数时间都是一样的: 用一个绑定了 Adapter 的 View 来展示数据. 然而一直这样会让我们对自己编写的代码变得盲目, 尽管那是辣鸡代码. 或者说, 我们一直在重复创造辣鸡代码.</p>
<p>让我们深入地看看 Adapter 的代码.</p>
<p>#RecyclerView 的基础<br>RecyclerView(同样适用于 ListView) 的基础操作:</p>
<ul>
<li>创建 View 和储存 View 信息的 ViewHolder.</li>
<li>根据 ViewHolder 储存的信息来绑定 ViewHolder , 大部分是 List 中的 model.</li>
</ul>
<p>这些步骤都比较简单, 一般不会出错.</p>
<p>#包含多种类型的 RecyclerView<br>当 View 需要展示多重不同的类型时, 事情就变得麻烦了. 比如下面这个例子.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mouse</span> <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Duck</span> <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span></span></span><br></pre></td></tr></table></figure>

<p>这个例子中,我们需要处理不同类型的动物, 而另一个对象”车”又与动物无关. 这意味着你需要创建不同的 ViewHolder 并对每一个 ViewHolder 初始化不同的布局. API 对每个类型定义了不同的 int 对象, 这就是辣鸡代码的开始.</p>
<p>让我们看看一些常见的代码, 当你需要多个类型时, 需要重写这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>默认实现返回0, 但多种类型时需要根据类型返回不同的值.</p>
<p>下一步,创建 ViewHolder, 即实现这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ItemViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>根据上一步 <code>getItemViewType()</code> 返回的不同 <code>viewType</code> 值来创建不同的 ViewHolder, 方法可能是 <code>switch</code> 语句或 <code>if-else</code>语句, 不过这个关系不大.</p>
<p>同样的, 在绑定这个创建了的(或者回收了的) ViewHolder 时, 也需要处理不同类型.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ItemViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>因为这里没有 type 参数, 所以会根据 ViewHolder 的 <code>Instance-of</code> 判断不同类型, 或者也可以在这些 ViewHolder 的基类中处理 onBind .</p>
<p>#不好的地方<br>所以上面这种实现有什么问题呢? 看起来不是很直观吗? </p>
<p>让我们再看一下 <code>getItemViewType()</code> 方法: 系统需要知道每个位置的类型, 所以你需要将你的数据列表中的每一项都转化成视图类型. 那就可能产生这种代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (things.get(position) == Duck) &#123;</span><br><span class="line">	<span class="keyword">return</span> TYPE_DUCK;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (things.get(position) == Mouse) &#123;</span><br><span class="line">	<span class="keyword">return</span> TYPE_MOUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你现在觉得这个代码糟糕吗? 如果不觉得, 那我们接下来看看 <code>onBindViewHolder()</code> 的实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ItemViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">   	Thing thing = things.get(position);</span><br><span class="line">   	<span class="keyword">if</span> (thing == Animal) &#123;</span><br><span class="line">   		((AnimalViewHolder) thing).bind((Animal) thing);</span><br><span class="line">   	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (thing == Car) &#123;</span><br><span class="line">   		((CarViewHolder) thing).bind((Car) thing);</span><br><span class="line">   	&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码看起来就很乱了, <code>Instance-of</code> 的检查和强制类型转化使这段代码非常违背设计模式.</p>
<p>许多年前我的显示器上就贴着一段引用自 Scott Meyers 所写的 <a target="_blank" rel="noopener" href="https://books.google.de/books/about/Effective_C++.html?id=eQq9AQAAQBAJ&source=kp_cover&redir_esc=y">Effective C++</a> 中的一段话:</p>
<blockquote>
<p>Anytime you find yourself writing code of the form “if the object is of type T1, then do something, but if it’s of type T2, then do something else,” slap yourself.</p>
</blockquote>
<blockquote>
<p>每次你发现自己写的代码是像”如果这个对象是 T1 类型, 就做这个, 或者如果这个对象是 T2 类型, 就做那个”的样式的话, 就扇自己一巴掌</p>
</blockquote>
<p>所以当然回头看 Adapter 的实现时, 就需要扇自己很多下.</p>
<ul>
<li>我们有很多类型检查和强制类型转化.</li>
<li>这是明显的适合使用面向对象却没有使用的代码.</li>
<li>实现方式违背了 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">SOLID</a> 原则中的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Open/closed_principle">开闭原则</a> , 即拓展时不需要修改内部实现.</li>
</ul>
<p>#尝试解决<br>一种替代方式就是在过程中间加上转化步骤, 比如一种很简单的方式就是把所有类的类型都放在一个 map 里面, 通过一次调用获取即可.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> types.get(thing.class);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这样做会好点吗?</p>
<p>不幸的是, 这不完全解决问题, 这种方式只是隐藏了 <code>Instance-of</code> 的检查.因为接下来实现 <code>onBindViewHolder()</code> 时还是会产生 <code>如果这个对象是 T1 类型, 就做这个, 或者如果这个对象是 T2 类型, 就做那个</code> 这样的代码.</p>
<p>我们的目标应该是 <strong>添加新的类型时不需要修改 Adapter 的代码</strong> .</p>
<p>因此, 一开始不需要在 Adapter 中创建视图和数据的对应关系. 另外 Google 也推荐使用布局 id 来区分不同类型, 这样你就不用自己定义每种类型了.</p>
<p>从另一个角度想, 如果我们想创建视图和数据的对应关系, 不一定非要从数据集入手, 可以对每个数据添加一个方法: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> R.layout.item_duck;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那 Adapter 中获取类型的方法就可以变成 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> things[position].getType();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这样就符合了开闭原则, 当我们想要添加新类型时不需要再改变 Adapter 中的代码.</p>
<p>但这种做法把架构中的每个层打乱了. 实体类型知道它的表现形式, 这种关系指向是错误的. <strong>对我们来说不可接受.</strong> 另一方面, 在数据中添加方法来表示它的类型, 这种做法并不是面向对象的, 我们只是再一次隐藏了 <code>Instance-of</code> 的检查.</p>
<p>#ViewModel 视图模型<br>更进一步的处理方法, 便是使用独立的视图模型而不是直接使用模型. 归根结底, 我们的数据是不想交的, 他们没有一个相同的基类: 车不是动物. 这对数据层来说是对的, 但对表现层来说, 他们都是展现在同一个视图中, 所以它们可以有一个共同的基类.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">type</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DuckViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.duck;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">CarViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.car;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这样就简单封装了数据. 当添加新的视图类型时, 不需要改动 Adapter 和原来的视图类型的代码. 比如 RecyclerView 的其他类型: 分割线, 段落头部, 广告等.</p>
<p>这只是一个比较接近的解决方法, 但并不唯一.</p>
<p>#The Visitor 访问者模式<br>如果你有很多模型类 (Model class) , 可能你不会向对每一个再创建对应的视图模型类 (ViewModel class). 那我们再来看看如何只使用数据模型 (model) .</p>
<p>一开始的时候, 当我们把 <code>type()</code> 方法加到每个模型中, 这种方法就太耦合了. 我们应该把方法抽象出来, 比如添加一个接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Visitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(TypeFactory typeFactory)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么每个模型就会变成这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> <span class="keyword">extends</span> <span class="title">Visitable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mouse</span> <span class="keyword">implements</span> <span class="title">Visitable</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(TypeFactory typeFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> typeFactory.type(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> <span class="keyword">implements</span> <span class="title">Visitable</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(TypeFactory typeFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> typeFactory.type(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而工厂类也应该是个抽象类, 它包含了所需的类型.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TypeFactory</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(Duck duck)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(Mouse mouse)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(Dog dog)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(Car car)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就完全是类型安全的实现, 不需要 <code>Instance-of</code> 的判断, 也不需要强制类型转化. 对于每个具体工厂的实现也是清晰的, 实现对应的类型即可.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeFactoryForList</span> <span class="keyword">extends</span> <span class="title">TypeFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">type</span><span class="params">(Duck duck)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.duck;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">type</span><span class="params">(Mouse mouse)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.mouse;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">type</span><span class="params">(Dog dog)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.dog;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">type</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> R.layout.car;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>当我们还想添加新的类型时, 这是我们需要添加代码的地方. 这就非常符合 <strong>SOLID</strong> 原则. 你可能需要别的方法给新的类型, 但不需要修改任何已经存在的方法: 对拓展打开, 对修改关闭.</p>
<p>现在你可能会问: 为什么不直接在 Adapter 使用工厂类, 而是使用抽象工厂呢?</p>
<p>因为只有这样才能保证类型安全, 避免类型转化或类型检查. 花点时间认真想想这里, 这里没有用到任何一个转化. 这就是访问者模式带来的间接性.</p>
<p>根据以上这些步骤能保证 Adapter 非常通用.</p>
<p>#结论</p>
<ul>
<li>尝试保持让你的实现代码简洁.</li>
<li><code>Instance-of</code> 检查应该是一个红色的警告标志.</li>
<li>注意向下转化, 这是不好的代码的味道.</li>
<li>尝试让上面那个点转化为正确的面向对象的用法, 想想接口和继承.</li>
<li>尝试用通用的点来阻止转化.</li>
<li>使用 ViewModel .</li>
<li>注意访问者模式的使用.</li>
</ul>
<p>我很乐于去学习更多让 Adapter 简洁的方法.</p>
<hr>
<p>其实这篇文章着重介绍的是优化的思路, 代码实现也只是给了一些小模块, 并不是完整的 Adapter 实现. </p>
<p>我沿着这个思路, 写了一个 Java 版本的 Demo :</p>
<p><a target="_blank" rel="noopener" href="https://github.com/niorgai/BetterAdapter">BetterAdapter</a>. 欢迎各位指导并提出宝贵的修改意见(我也认为这个实现还是有改进空间).</p>
<p>在实现的过程中, 发现了一些需要注意的地方.</p>
<ul>
<li>由于每个 Adapter 中可能 model 和 type 的对应不同, 比如同一个 model M , 在 Adapter a1 中对应 type1, 在 Adapter a2 中对应 type2, 所以 <code>onCreateViewHolder</code> 的实现也需要放在 <code>TypeFactory</code> 中解耦.</li>
<li>为了解耦(同时也是因为想不到好一点的写法), 我抽出了一个 <code>BetterHolder</code> 作为 <code>ViewHolder</code> 的基类. 然后为每个类型创建对应的 holder 来实现不同的 <code>onCreateViewHolder</code> 和 <code>onBindViewHolder</code>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BetterViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BetterViewHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BetterViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(BetterViewHolder holder)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>所有的数据必须以平级的方式添加进去, 并且需要按照顺序添加. 如果后台 json 数据返回的格式如下:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	key_a : A</span><br><span class="line">	key_b : &#123;</span><br><span class="line">			A,</span><br><span class="line">			A</span><br><span class="line">	&#125;</span><br><span class="line">	key_c : C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在添加的时候:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mAdapter.add(A);</span><br><span class="line"><span class="comment">//把 key_b 数组遍历</span></span><br><span class="line">mAdapter.add(A);</span><br><span class="line">mAdapter.add(A);</span><br><span class="line">mAdapter.add(C);</span><br></pre></td></tr></table></figure>

<p>###一点题外话</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/drakeet">drakeet</a> 所写的 <a target="_blank" rel="noopener" href="https://github.com/drakeet/MultiType">MultiType</a> 也是一种很好的方法, 同时他也写了一篇博客 <a target="_blank" rel="noopener" href="https://drakeet.me/multitype">Android 复杂的多类型列表视图新写法：MultiType</a> 来介绍这个库. 只是我个人不喜欢在这些很基础的地方使用自己没有理解透的第三方库, 所以才没有用到项目中. 不过我很看好这个库.</li>
<li>无论是上面提到的 <a target="_blank" rel="noopener" href="https://github.com/drakeet/MultiType">MultiType</a> , 还是原文中提到的 BetterAdapter , 最终想要的都是解耦. 如果解决了 model 和 holder 之间的一一对应, 理论上来说一个 Application 只要维护一个 Adapter 就行了. 当然这是我的想法, 哈哈.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/11/02/Android-VideoView-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/11/02/Android-VideoView-tips/" class="post-title-link" itemprop="url">原生VideoView使用总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-11-02 22:43:27" itemprop="dateCreated datePublished" datetime="2016-11-02T22:43:27+08:00">2016-11-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2016-11-03 00:33:40" itemprop="dateModified" datetime="2016-11-03T00:33:40+08:00">2016-11-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E9%80%82%E9%85%8D%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">Android适配经验</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/11/02/Android-VideoView-tips/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/11/02/Android-VideoView-tips/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Android 上原生的控件 <code>VideoView</code> 当然是做视频播放的首选,使用简单,下面介绍一下自己在项目使用过程中的一些注意点.</p>
<ol>
<li><p>宽高问题.</p>
<ol>
<li>由 <code>VideoView</code> 的源码可知,不管你设置的 <code>View</code> 的宽高是多少, <code>VideoView</code> 会根据视频文件的宽高重新设置 <code>View</code> 的宽高,最终显示效果类似于 <code>ImageView</code> 的 <code>FIT_CENTER</code>.</li>
<li>如果想自定义宽高,做到 <code>FIT_XY</code> 的效果,就需要继承 <code>VideoView</code> 重写 <code>onMeasure</code> 方法.</li>
</ol>
</li>
<li><p>播放和暂停/恢复.</p>
<ol>
<li><p>播放调用 <code>setVideoPath()</code> 或 <code>setVideoURI()</code> 即可, <code>VideoView</code> 会异步加载视频,加载完毕回调 <code>OnPreparedListener()</code> .如果播放本地视频,放进 <code>raw</code> 文件夹,如 <code>video_guide.mp4</code>.</p>
<pre><code> mVideoView.setVideoPath(&quot;android.resource://&quot; + getPackageName() + &quot;/raw/video_guide&quot;);
 mVideoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() &#123;
     @Override
     public void onPrepared(MediaPlayer mp) &#123;
             mp.start();
     &#125;
   &#125;</code></pre>
</li>
<li><p>暂停: <code>pause()</code>.</p>
</li>
<li><p>恢复: <code>start()</code>.注意这里不要调用 <code>resume()</code>.</p>
</li>
</ol>
</li>
<li><p>进度条.</p>
<ol>
<li><p>进度检测</p>
<p> UI中一般会有一个 <code>SeekBar</code> 来显示当前播放进度,这里我采取是定时刷新的的办法:</p>
<p> 1.在 <code>OnPreparedListener()</code> 中设置 <code>SeekBar</code> 的 max 值.</p>
<pre><code> mSeekBar.setMax(mp.getDuration());</code></pre>
<p> 2.通过 <code>Handler</code> 每秒计算 <code>SeekBar</code> 的位置.</p>
<pre><code> mSeekBar.setProgress(mVideoView.getCurrentPosition()).</code></pre>
</li>
<li><p>进度条拖动,必然是通过 <code>OnSeekBarChangeListener()</code> 监控.</p>
<pre><code> mSeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() &#123;
     @Override
     public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) &#123;
             //建议在这里更新显示当前拖动的时间
     &#125;

     @Override
     public void onStartTrackingTouch(SeekBar seekBar) &#123;
             //建议在这里(开始拖动时)停止倒计时
     &#125;

     @Override
     public void onStopTrackingTouch(SeekBar seekBar) &#123;
             //建议在这里(停止拖动时)将 VideoView seekTo 当前位置.
     &#125;
 &#125;);

同时在 `OnPreparedListener()` 中, 为 `MediaPlayer` 设置 `OnSeekCompleteListener()` 来监听滑动停止.

    mp.setOnSeekCompleteListener(new MediaPlayer.OnSeekCompleteListener() &#123;
         @Override
         public void onSeekComplete(MediaPlayer mp) &#123;
             //同时开始倒计时
             mVideoView.start();
         &#125;
     &#125;);</code></pre>
</li>
</ol>
</li>
<li><p>显示和隐藏 Loading 图.</p>
<p> 如果播放网络视频,难免会遇到缓冲的情况,除了视频需要切片之外,客户端还需要监听缓冲状态以显示/隐藏 Loading 图.</p>
<pre><code> mp.setOnInfoListener(new MediaPlayer.OnInfoListener() &#123;
                 @Override
                 public boolean onInfo(MediaPlayer mp, int what, int extra) &#123;
                     switch (what) &#123;
                         case MediaPlayer.MEDIA_INFO_BUFFERING_START:
                             //显示 Loading 图
                             break;
                         case MediaPlayer.MEDIA_INFO_BUFFERING_END:
                             //隐藏 Loading 图
                             break;
                     &#125;
                     return false;
                 &#125;
             &#125;);</code></pre>
</li>
<li><p>“无法加载此视频”的提示.</p>
<p> 如果是一个无法播放的视频,会弹出一个”无法播放此视频”的 Dialog. 从体验的角度来说就算无法播放也不能用这样的 Dialog 来提示,查看源码可知, 只需要为 <code>VideoView</code> 设置  <code>OnErrorListener()</code> 即可.</p>
</li>
<li><p>横竖屏切换.</p>
<p> 视频当然是全屏播放最好,此时就需要将 <code>Activity</code> 变为横屏.</p>
<ol>
<li><p>在 <code>AndroidManifest.xml</code> 设置当前 <code>Activity</code> 的 <code>configChanges</code> 属性.</p>
<pre><code> android:configChanges=&quot;orientation</code></pre>
</li>
<li><p>通过代码改变当前 <code>Activity</code> 的横竖屏.</p>
<pre><code> //横屏activity.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);
 //竖屏activity.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);</code></pre>
</li>
<li><p>在 <code>View</code> 或 <code>Activity</code> 的 <code>onConfigurationChanged()</code> 回调中处理横竖屏切换.</p>
<pre><code> @Override
 protected void onConfigurationChanged(Configuration newConfig) &#123;
     super.onConfigurationChanged(newConfig);
     if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;
         //横屏
     &#125; else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &#123;
         //竖屏
     &#125;
 &#125;</code></pre>
</li>
</ol>
</li>
<li><p>切换后台或打开新页面(即经过 <code>Activity</code> 的 <code>onStop()</code> 生命周期.</p>
<p> 因为 <code>VideoView</code> 继承了 <code>SurfaceView</code> , 在 <code>Activity</code> 的 <code>onStop()</code> 生命周期中会调用 <code>surfaceDestroyed()</code>, 此时会释放 <code>MediaPlayer</code>, 所以当切换后台或打开新页面回来,视频就会重头播放,暂时还没想到解决办法.                    </p>
</li>
</ol>
<p>以上就是关于原生 <code>VideoView</code> 的简单使用, 下一步我考虑切换到 Google 的 <a target="_blank" rel="noopener" href="https://github.com/google/ExoPlayer">ExoPlayer</a> , 如果使用顺利我会继续总结.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/06/13/use-Apache-mina-to-build-TCP-connect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/13/use-Apache-mina-to-build-TCP-connect/" class="post-title-link" itemprop="url">使用 Apache mina 建立长连接</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-13 10:47:18" itemprop="dateCreated datePublished" datetime="2016-06-13T10:47:18+08:00">2016-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-05-16 10:41:37" itemprop="dateModified" datetime="2017-05-16T10:41:37+08:00">2017-05-16</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/06/13/use-Apache-mina-to-build-TCP-connect/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/06/13/use-Apache-mina-to-build-TCP-connect/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由于业务需要,有一些实时性要求高的接口从无状态的 HTTP 连接切换到了长连接, 所以最近基于 Apache mina 来实现了长连接.主要说明一下 Android 客户端的实现.</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>对于 Android 客户端来说, 不需要引入太多的包.</p>
<p>首先<a target="_blank" rel="noopener" href="http://mina.apache.org/mina-project/downloads.html">下载 mina </a>, 目前我用的版本是 2.0.13, 解压后引入 <code>mina-core-2.0.13.jar</code> 包. 然后<a target="_blank" rel="noopener" href="http://www.slf4j.org/android/">下载 slf4j-android </a>包,引入 <code>slf4j-android-1.6.1-RC1.jar</code>包.只需两个 jar 包即可.</p>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><p>主要代码如下(<strong>注意一定不能在主线程中连接</strong>):</p>
<pre><code>SocketConnector mSocketConnector = new NioSocketConnector();
//设置协议封装解析处理
mSocketConnector.getFilterChain().addLast(&quot;protocol&quot;, new ProtocolCodecFilter(new FrameCodecFactory()));
//设置心跳包
KeepAliveFilter heartFilter = new KeepAliveFilter(new HeartbeatMessageFactory());
heartFilter.setRequestInterval(5 * 60);
heartFilter.setRequestTimeout(10);
mSocketConnector.getFilterChain().addLast(&quot;heartbeat&quot;, heartFilter);
//设置 handler 处理业务逻辑
mSocketConnector.setHandler(new SocketClientHandler());
   //配置服务器地址
InetSocketAddress mSocketAddress = new InetSocketAddress(IP, PORT);
ConnectFuture mFuture = mSocketConnector.connect(mSocketAddress);
mFuture.awaitUninterruptibly();
IoSession mSession = mFuture.getSession();</code></pre>
<p>TCP 的连接重点在于协议的处理和心跳.由于三次握手和粘包等问题已经在框架中处理好了,所以只需要配置<code>协议的封装处理</code>, <code>心跳包的设计</code> 和 <code>业务逻辑的处理</code>皆可.</p>
<p>前两者可以使用 mina 框架的 filterchain 来处理, 通过设置 Filter 使数据的发送返回结果更加符合自己的需求. <code>addLast</code> 等方法只是通过 key, value 的形式添加 Filter, 前面的 key 可以随意. Filter 的用法可以参考 <a target="_blank" rel="noopener" href="http://mina.apache.org/mina-project/userguide/ch9-codec-filter/ch9-codec-filter.html">mina官网</a>.</p>
<h2 id="协议的封装处理"><a href="#协议的封装处理" class="headerlink" title="协议的封装处理."></a>协议的封装处理.</h2><p>在项目中,我把 FrameCodecFactory 用作第一个 Filter, 对接收到的数据做第一步处理, 解析为我想要的格式, 同时把发出去的数据封装为服务器接受的格式.</p>
<p>这里项目中所使用的是 <code>Frame</code> 协议, <strong>前四位表示数据的长度,后面接收该长度的数据,解析处理.</strong></p>
<pre><code>public class FrameCodecFactory implements ProtocolCodecFactory &#123;

    @Override
    public ProtocolEncoder getEncoder(IoSession ioSession) throws Exception &#123;
        return new FrameEncoder();
    &#125;

    @Override
    public ProtocolDecoder getDecoder(IoSession ioSession) throws Exception &#123;
        return new FrameDecoder();
    &#125;
&#125;</code></pre>
<p>主要内容在于 Encoder 和 Decoder.</p>
<p>Encoder 用于封装你所发出的数据, 封装为服务器接受的格式. 这里是将 String 转为 Frame 协议.</p>
<pre><code>public class FrameEncoder implements ProtocolEncoder &#123;

    @Override
    public void encode(IoSession ioSession, Object o, ProtocolEncoderOutput protocolEncoderOutput) throws Exception &#123;
        if (o instanceof String) &#123;
            String messageString = (String) o;
            //封装为 Frame 协议
            byte[] messageBytes = messageString.getBytes(Charset.forName(&quot;UTF-8&quot;));
            int totalSize = messageBytes.length + 4;
            IoBuffer buffer = IoBuffer.allocate(totalSize);
            buffer.putInt(totalSize);
            buffer.put(messageBytes);
            buffer.flip();
            protocolEncoderOutput.write(buffer);
        &#125;
    &#125;

    @Override
    public void dispose(IoSession ioSession) throws Exception &#123;

    &#125;
&#125;</code></pre>
<p>Decoder 用于解析接收到的数据, 将 Frame 格式的数据流解析为 String.</p>
<pre><code>public class FrameDecoder extends CumulativeProtocolDecoder &#123;

    @Override
    protected boolean doDecode(IoSession ioSession, IoBuffer ioBuffer, ProtocolDecoderOutput protocolDecoderOutput) throws Exception &#123;
        int totalLength = ioBuffer.getInt();
        int messageLength = totalLength - 4;
        if (ioBuffer.remaining() &gt;= messageLength) &#123;
            String messageString = ioBuffer.getString(messageLength, Charset.forName(&quot;UTF-8&quot;).newDecoder());
            protocolDecoderOutput.write(messageString);
            return true;
        &#125;
        return false;
    &#125;
&#125;</code></pre>
<p>在 FrameCodecFactory 这个 Filter 处理完后, 对于客户端的处理便可以使用 String 来传递解析数据了.</p>
<h2 id="心跳包的处理"><a href="#心跳包的处理" class="headerlink" title="心跳包的处理"></a>心跳包的处理</h2><p>心跳包是判断 TCP 连接是否在线的关键, 在这里直接继承 <code>KeepAliveMessageFactory</code> ,实现对应的方法即可.</p>
<pre><code>public class HeartbeatMessageFactory implements KeepAliveMessageFactory &#123;

    @Override
    public boolean isRequest(IoSession ioSession, Object o) &#123;
           //如果是客户端主动向服务器发起的心跳包, return true, 该框架会发送 getRequest() 方法返回的心跳包内容. 
        return false;
    &#125;

    @Override
    public boolean isResponse(IoSession ioSession, Object o) &#123;
        //如果是服务器发送过来的心跳包, return true后会在 getResponse() 方法中处理心跳包.
        return false;
    &#125;

    @Override
    public Object getRequest(IoSession ioSession) &#123;
        //自定义向服务器发送的心跳包内容.
        return null;
    &#125;

    @Override
    public Object getResponse(IoSession ioSession, Object o) &#123;
        //自定义解析服务器发送过来的心跳包. 
       return null;
    &#125;
&#125;</code></pre>
<p>主要的心跳包内容及格式都可以在这里处理, 在实例化这个对象时可以设置间隔及超时时间.</p>
<pre><code>KeepAliveFilter heartFilter = new KeepAliveFilter(new HeartbeatMessageFactory());
//每 5 分钟发送一个心跳包
heartFilter.setRequestInterval(5 * 60);
//心跳包超时时间 10s
heartFilter.setRequestTimeout(10);</code></pre>
<h2 id="业务逻辑处理"><a href="#业务逻辑处理" class="headerlink" title="业务逻辑处理 "></a>业务逻辑处理 </h2><p>数据通过 Filter 过滤后, 便会到设置的 Handler 的 <code>messageReceived()</code> 方法中回调. 我在这里处理对应的业务逻辑.</p>
<pre><code>public class SocketClientHandler extends IoHandlerAdapter &#123;

    @Override
    public void messageReceived(IoSession session, Object message) throws Exception &#123;
        //处理业务,分发数据,可以利用广播等方式.
    &#125;

&#125;</code></pre>
<h2 id="断开链接"><a href="#断开链接" class="headerlink" title="断开链接    "></a>断开链接    </h2><p>断开链接也不能在主线程中调用.</p>
<pre><code>mFuture.cancel();
   mSession.closeNow();
   mSession.getCloseFuture().setClosed();
   mSession.getCloseFuture().awaitUninterruptibly();
//如果完全不连接了
mSocketConnector.dispose();</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>之前没有实现过长连接, 一开始做的时候还以为要自己实现三次握手,拆包等问题,后面才发现这些东西都已经通过 mina 实现好了, 同时无论 netty 还是 mina, 通过 filterchain 这种方式对消息处理的解耦很方便, 每个步骤只需要实现它对应需要实现的方法即可.客户端只需要维护一个 client 对象, 通过广播等方式分发数据, 目前实现还没有遇到什么大坑~.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/04/16/Android-Filter-Java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/16/Android-Filter-Java/" class="post-title-link" itemprop="url">Android Java代码实现滤镜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-04-16 01:15:20 / Modified: 01:38:13" itemprop="dateCreated datePublished" datetime="2016-04-16T01:15:20+08:00">2016-04-16</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/04/16/Android-Filter-Java/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/04/16/Android-Filter-Java/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目前很多应用实现滤镜的方式都是使用 ndk 开发,如大名鼎鼎的 <a target="_blank" rel="noopener" href="https://github.com/CyberAgent/android-gpuimage">GPUImage</a> ,但是使用 ndk 的方法就需要为不同的 abi 提供不同的 .so 文件,感觉维护起来比较麻烦,这里就给出一种简单的 Java 版本的滤镜实现.</p>
<p>目前可以找到的改变的值有 <strong>亮度</strong>, <strong>饱和度</strong>, <strong>对比度</strong>, <strong>色温</strong>, 前三者需要用到 <code>ColorMatrix</code> 这个类, 后面的色温用到 <code>ColorFilter</code> 这个类.</p>
<ul>
<li><p>亮度</p>
<pre><code>  ColorMatrix lMatrix = new ColorMatrix();
  lMatrix.set(new float[]&#123;
          1, 0, 0, 0, light,
          0, 1, 0, 0, light,
          0, 0, 1, 0, light,
          0, 0, 0, 1, 0&#125;);</code></pre>
</li>
<li><p>饱和度</p>
<pre><code>  ColorMatrix cMatrix = new ColorMatrix();
     cMatrix.setSaturation(saturation);</code></pre>
</li>
<li><p>对比度</p>
<pre><code>  float contrast;
  float scale = (contrast / 255f - 0.5f) / -0.5f;
  ColorMatrix dMatrix = new ColorMatrix();
  dMatrix.set(new float[]&#123;
          scale, 0, 0, 0, contrast,
          0, scale, 0, 0, contrast,
          0, 0, scale, 0, contrast,
          0, 0, 0, 1, 0&#125;);</code></pre>
</li>
</ul>
<p>联合以上三个属性,只需要将三个矩阵连接起来即可.</p>
<pre><code>    ColorMatrix finalMatrix = new ColorMatrix();
    finalMatrix.postConcat(cMatrix);
    finalMatrix.postConcat(lMatrix);
    finalMatrix.postConcat(dMatrix);
    ImageView.setColorFilter(new ColorMatrixColorFilter(finalMatrix));</code></pre>
<ul>
<li><p>色温</p>
<p>  色温主要调节冷暖,但是因为没有具体的换算公式,所以我采用查表的方法 <a target="_blank" rel="noopener" href="http://www.vendian.org/mncharity/dir3/blackbody/UnstableURLs/bbr_color.html">色温表</a>. 查表后对 <code>Drawable</code> 对象调用 <code>setColorFilter</code> 方法在其上面再覆盖一层颜色.</p>
<pre><code>  String color = &quot;#818181&quot;;//查表得
  drawable.setColorFilter(Color.parseColor(color), PorterDuff.Mode.MULTIPLY);</code></pre>
</li>
</ul>
<h2 id="保存-Bitmap"><a href="#保存-Bitmap" class="headerlink" title="保存 Bitmap    "></a>保存 Bitmap    </h2><p>在设置这些属性的时候,都是对 ImageView 或 Drawable 操作, 但如果需要保存, 还是需要 Bitmap 对象.以下代码便是提供保存滤镜 Bitmap 的方法:</p>
<pre><code>    .....
    ColorMatrix finalMatrix = new ColorMatrix();
    finalMatrix.postConcat(cMatrix);
    finalMatrix.postConcat(lMatrix);
    finalMatrix.postConcat(dMatrix);
    ....
    Bitmap bmp = Bitmap.createBitmap(imageWidth, imageHeight,
            Bitmap.Config.ARGB_8888);
    Paint paint = new Paint();
    paint.setColorFilter(new ColorMatrixColorFilter(finalMatrix));

    Canvas canvas = new Canvas(bmp);
    canvas.drawBitmap(mOriginBitmap, 0, 0, paint);
    //此时bmp即为所需要保存的Bitmap</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/03/20/status_bar/Android-transulcent-status-bar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/20/status_bar/Android-transulcent-status-bar/" class="post-title-link" itemprop="url">Android-transulcent-status-bar</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-03-20 20:02:19" itemprop="dateCreated datePublished" datetime="2016-03-20T20:02:19+08:00">2016-03-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-10-15 00:28:57" itemprop="dateModified" datetime="2018-10-15T00:28:57+08:00">2018-10-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E9%80%82%E9%85%8D%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">Android适配经验</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/03/20/status_bar/Android-transulcent-status-bar/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/20/status_bar/Android-transulcent-status-bar/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>透明状态栏适配.主要适用场景为一个<code>Activity</code>多个<code>tab</code>在不同状态栏模式下切换.</p>
<p>Github Demo 链接: <a target="_blank" rel="noopener" href="https://github.com/niorgai/StatusBarCompat">StatusBarCompat</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章:"></a>参考文章:</h2><ol>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/140be70b84cd?utm_source=tuicool&utm_medium=referral">由沉浸式状态栏引发的血案</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/0acc12c29c1b">Translucent System Bar 的最佳实践</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chengyunfeng.com/?p=905#ixzz43Roc61no">该使用 fitsSystemWindows 了！</a></li>
<li><a target="_blank" rel="noopener" href="http://gold.xitu.io/entry/570736071ea493005dc640ac">Android 透明状态栏实现方案</a></li>
<li><a href="hqttp://blog.csdn.net/u013260551/article/details/51150336">更简单更全的material design状态栏</a></li>
</ol>
<hr>
<p>首先强调,对于状态栏的处理有两种不同的方式, 这里从<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/0acc12c29c1b">Translucent System Bar 的最佳实践</a>直接盗了两张图做对比~.</p>
<table>
<thead>
<tr>
<th>全屏( ContentView 可以进入状态栏)</th>
<th>非全屏 ( ContentView 与状态栏分离, 状态栏直接着色)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="image/fullScreen.png"></td>
<td><img src="image/Toolbar.png"></td>
</tr>
</tbody></table>
<p>先定义几个名词:</p>
<ol>
<li><strong>全屏模式</strong>: 左边图所示.</li>
<li><strong>着色模式</strong>: 右边图所示.</li>
<li><strong>ContentView</strong>: <code>activity.findViewById(Window.ID_ANDROID_CONTENT)</code> 获取的 View , 即 <code>setContentView</code> 方法所设置的 View, 实质为 <code>FrameLayout</code>.</li>
<li><strong>ContentParent</strong>: <code>ContentView</code> 的 parent , 实质为 <code>LinearLayout</code>.</li>
<li><strong>ChildView</strong>: <code>ContentView</code> 的第一个子 View ,即布局文件中的 root layout .</li>
</ol>
<p>再介绍一下相关的函数:</p>
<ol>
<li><code>fitsSystemWindows</code>, 该属性可以设置是否为系统 View 预留出空间, 当设置为 true 时,会预留出状态栏的空间.</li>
<li><code>ContentView</code>, 实质为 <code>ContentFrameLayout</code>, 但是重写了 <code>dispatchFitSystemWindows</code> 方法, 所以对其设置 <code>fitsSystemWindows</code> 无效.</li>
<li><code>ContentParent</code>, 实质为 <code>FitWindowsLinearLayout</code>, 里面第一个 View 是 <code>ViewStubCompat</code>, 如果主题没有设置 title ,它就不会 inflate .第二个 View 就是 <code>ContentView</code>.</li>
<li><code>requestApplyInsets()</code>, 当窗口(Window)大小改变了,通知 View 去消费窗口的改变.</li>
<li><code>FLAG_TRANSLUCENT_STATUS</code>, 设置全屏的标志位, 此时界面可以延伸到状态栏.</li>
</ol>
<h2 id="5-0以上的处理"><a href="#5-0以上的处理" class="headerlink" title="5.0以上的处理:"></a>5.0以上的处理:</h2><p>自5.0引入 Material Design ,状态栏对开发者更加直接,可以直接调用 <code>setStatusBarColor</code> 来设置状态栏的颜色.</p>
<p>**着色模式: **</p>
<p>通过查看 <code>setStatusBarColor()</code> 方法的文档,发现在调用该方法时需要设置以下属性:</p>
<ol>
<li>添加 <code>FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS</code> Flag(绘制系统栏).</li>
<li>清除 <code>FLAG_TRANSLUCENT_STATUS</code> Flag(透明状态栏).</li>
<li>调用 <code>setStatusBarColor()</code> 设置状态栏颜色.</li>
</ol>
<p>**全屏模式: **</p>
<p>由于 5.0 以上为状态栏添加了一个阴影, 所以为全屏模式添加了是否隐藏状态栏阴影的方法.</p>
<ul>
<li><p>隐藏阴影</p>
<ol>
<li>像着色模式一样添加 flag ,然后通过 <code>setStatusBarColor()</code> 设置颜色为透明.</li>
<li>通过 <code>setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN)</code> 隐藏状态栏颜色.</li>
</ol>
</li>
<li><p>显示阴影</p>
<ol>
<li>设置 <code>FLAG_TRANSLUCENT_STATUS</code> 来隐藏状态栏.</li>
<li>通过 <code>setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE)</code> 来恢复默认状态栏样式.</li>
</ol>
</li>
</ul>
<h2 id="4-4-5-0的处理"><a href="#4-4-5-0的处理" class="headerlink" title="4.4-5.0的处理:"></a>4.4-5.0的处理:</h2><p>4.4-5.0因为没有直接的 API 可以调用,需要自己兼容处理.参考了网上的解决方法及结合我自己遇到的坑,最后想出的解决办法如下:</p>
<p><strong>着色模式</strong></p>
<ol>
<li>向 <code>DecorView</code> 中添加一个 View, 高度为状态栏的高度(反射获取).</li>
<li>将 <code>ChildView</code> 的 marginTop 加上状态栏的高度,以此来模拟 <code>fitsSystemWindows</code>.</li>
<li>设置 <code>ChildView</code> 的 fitsSystemWindow 为 false, 不预留系统栏位置.</li>
<li>为 <code>DecorView</code> 设置一个 tag, 防止重复添加 View.</li>
</ol>
<p>这里与其他地方不同的是:</p>
<ol>
<li>向 <code>ContentView</code> 添加 View 在部分机型(华为)上没有效果.</li>
<li>向 <code>ContentParent</code> 上添加 View 会有一条黑线.</li>
<li>使用 marginTop 而不是 <code>fitsSystemWindows</code> 是因为无法在**不重启 Activity **的情况下切换 root layout 的<code>fitsSystemWindows</code>属性, 即直接设置不会生效, 所以用 marginTop 来模拟.</li>
</ol>
<p><strong>全屏模式</strong></p>
<ol>
<li>设置 <code>ChildView</code> 的 fitsSystemWindow 为 false, 不预留系统栏位置.</li>
<li>如果在 <code>ChildView</code> 的 marginTop 中添加了状态栏的高度, 则移除.</li>
<li>设置 tag, 防止重复移除.</li>
</ol>
<p>** CollaspingToolbarLayout **<br>这个 support 包中的控件, 由于重写了 <code>onApplySystemInsets()</code> 方法, 按照我所理解的状态栏模式, 它在滑动时在两种模式中切换, 对此我的兼容方法就是让其处于 <strong>着色模式</strong> 下,在滑动时保持状态栏颜色不变. 当然有更好的解决办法, 但我这里为了方便调用(只需要传递 Activity 对象), 就用了比较简单的处理方法.</p>
<h2 id="CollapsingToolbarLayout"><a href="#CollapsingToolbarLayout" class="headerlink" title="CollapsingToolbarLayout"></a>CollapsingToolbarLayout</h2><p>support 包中提供的 <code>CollapsingToolbarLayout</code>, 在使用的时候大概的布局是这样的(参考 <a target="_blank" rel="noopener" href="https://github.com/chrisbanes/cheesesquare">CheeseSquare</a> ):</p>
<pre><code>&lt;CoordinatorLayout
    android:fitsSystemWindows=&quot;true&quot;&gt;

    &lt;AppBarLayout
        android:fitsSystemWindows=&quot;true&quot;&gt;

        &lt;CollapsingToolbarLayout
            android:fitsSystemWindows=&quot;true&quot;&gt;

            &lt;View
                android:fitsSystemWindows=&quot;true&quot;
                 app:layout_collapseMode=&quot;parallax&quot;/&gt;

          &lt;ToolBar
              app:layout_collapseMode=&quot;pin&quot;/&gt;

       &lt;/CollapsingToolbarLayout&gt;

   &lt;AppBarLayout/&gt;

   &lt;View
           app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot;/&gt;

&lt;/CoordinatorLayout&gt;</code></pre>
<p>在适配的时候主要遇到以下几个问题:</p>
<ol>
<li>如果按照我上面介绍的方式来说, 它在显示图片的时候是 <code>全屏模式</code> , 在显示 <code>Toolbar</code> 的时候是 <code>着色模式</code>.</li>
<li><code>CollapsingToolbarLayout</code> 的内部在 5.0 及以上的版本中通过 <code>OnApplyWindowInsetsListener()</code> 中获取的 Insets 对象, 在 Layout 的过程中将 View 向下偏移了, 所以它在 5.0 及以上系统中可以占据状态栏, 在 4.4 系统上则不能.</li>
<li>仿照 <a target="_blank" rel="noopener" href="https://github.com/chrisbanes/cheesesquare">CheeseSquare</a> 这个库中的写法, <code>CollapsingToolbarLayout</code> 需要设置 <code>FitsSystemWindow</code> 为 true, 而我在前面兼容 <code>全屏模式</code> 和 <code>着色模式</code> 的时候, 都是设置 <code>FitsSystemWindow</code> 为 false. 同时目前我没找到方法在不重启 Activity 的情况下切换 <code>FitsSystemWindow</code>.</li>
</ol>
<p>在参考了网上的文章后,最后决定通过以下方法来处理.</p>
<ul>
<li><p>4.4版本:</p>
<ol>
<li>变为全屏模式,设置 View 的 <code>fitsSystemWindow</code> 为 false, 这一步可以使 <code>CollapsingToolbarLayout</code> 占据状态栏, <code>Toolbar</code> 也是.</li>
<li>改变 <code>Toolbar</code> 的高度, 加上状态栏的高度, 让 <code>Toolbar</code> 挡住状态栏位置, 同时为 <code>Toolbar</code> 添加 paddingTop , 这样就可以让 title 正常显示.</li>
<li>添加假的 <code>StatusView</code> 模拟状态栏颜色, 通过 <code>AppBarLayout</code> 的 <code>OnOffsetChangedListener()</code> 监听 <code>AppBarLayout</code> 的滑动, 使 <code>StatusView</code> 跟随 <code>CollapsingToolbarLayout</code> 的显示隐藏.</li>
</ol>
</li>
<li><p>5.0及以上版本:</p>
<ol>
<li>变为全屏模式,设置 View 的 <code>fitsSystemWindow</code> 为 false, 这一步可以使 <code>CollapsingToolbarLayout</code> 占据状态栏, <code>Toolbar</code> 也是.</li>
<li>改变 <code>Toolbar</code> 的高度, 加上状态栏的高度, 让 <code>Toolbar</code> 挡住状态栏位置, 同时为 <code>Toolbar</code> 添加 paddingTop , 这样就可以让 title 正常显示. 这都和 4.4 一样.</li>
<li>为 <code>CollapsingToolbarLayout</code> 设置 <code>OnApplyWindowInsetsListener()</code> 使其正常 Layout ,因为此时 <code>CollapsingToolbarLayout</code> 已经显示到状态栏了, 不需要在 Layout 过程中向下偏移, 但是此时<code>collapsingToolbarLayout.setStatusBarScrimColor()</code> 也就<strong>无效</strong>了.</li>
<li>通过 <code>AppBarLayout</code> 的 <code>OnOffsetChangedListener()</code> 监听 <code>AppBarLayout</code> 的滑动, 利用 <code>setStatusBarColor()</code> 设置状态栏颜色即可.</li>
</ol>
</li>
</ul>
<h2 id="关于博客和库"><a href="#关于博客和库" class="headerlink" title="关于博客和库"></a>关于博客和库</h2><p>博客主要提供思路解析,因为博客的通知不及时,大家有问题有想法想交流时还请在 Github issues 页联系.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/01/30/Android-tab-with-fragment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/01/30/Android-tab-with-fragment/" class="post-title-link" itemprop="url">Android使用Fragment切换tab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-01-30 22:15:19" itemprop="dateCreated datePublished" datetime="2016-01-30T22:15:19+08:00">2016-01-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-02-28 16:36:06" itemprop="dateModified" datetime="2018-02-28T16:36:06+08:00">2018-02-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%BC%80%E5%8F%91%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">Android开发经验</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/01/30/Android-tab-with-fragment/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/30/Android-tab-with-fragment/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目前很多应用都是采用的底部导航+Tab的方式.目前项目中采用的是<code>RadioButton + FrameLayout + Fragment</code>的实现方式,所以总结一下遇到的几个问题.</p>
<ol>
<li><p>Activity重建导致Fragment重叠.</p>
<ul>
<li>复现方式: 系统销毁Activity,如改变字体大小.</li>
<li>问题原因: Activity销毁时,系统会保存该Activity状态,而<code>onCreate(Bundle state)</code>会导致Activity的</li>
<li>解决方法:<ul>
<li>在Activity销毁时不保存状态.如重写<code>onSaveInstanceState (Bundle outState)</code>并且不调用super方法,即在Activity销毁时不保存状态.但是该方式会导致<strong>Application创建两次</strong>.</li>
<li>在Activity创建时,调用<code>super.onCreate(null)</code>,即不根据其保存的状态来恢复Activity状态,而是直接重新创建.这算是一种偷懒的办法吧.</li>
<li>在利用 <code>FragmentManager</code> addFragment 时,将每个 Fragment 设置不同的tag. 然后在 Activity 的 <code>onCreate (Bundle savedInstanceState)</code> 方法中, 利用 <code>FragmentManager</code> 根据不同 tag 来获取已经创建并添加了的 Fragemnt, 而不用重复创建.</li>
</ul>
</li>
</ul>
</li>
<li><p>FragmentTransaction 在 commit 时, 如果 Activity 正在销毁, 会导致崩溃.</p>
<p> 异常为: <code>java.lang.IllegalStateException: Can not perform this action after onSaveInstance！</code></p>
<p> 意思就是不能在 onSaveInstance() 后调用 commit 方法, 而 onSaveInstance() 是做状态保存工作, 调用时间由系统决定的, 它只能保证在 onStop() 前调用. </p>
<ul>
<li>最好在 <code>FragmentActivity#onResumeFragments()</code> 或 <code>Activity#onPostResume()</code> 中调用 commit . 这两个方法能确保当前 Activity 的状态已经恢复.</li>
<li>如果确保这个 commit 丢失也没关系, 可以使用<code>FragmentTransaction#commitAllowingStateLoss();</code></li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>Fragment中调用<code>getContext()</code>或<code>getActivity()</code>为null导致崩溃.</p>
<ul>
<li><p>复现方式: detach一个Fragment,然后异步函数调用<code>getContext()</code>.</p>
</li>
<li><p>问题原因: <code>onDetach()</code>调用后,<code>getContext()</code>会置为null.</p>
</li>
<li><p>解决方法:</p>
<ul>
<li><p>在BaseFragment中维护一个mContext,然后重写<code>onAttach(Context context)</code>方法:</p>
<pre><code>  @Override
  public void onAttach(Activity activity) &#123;
      super.onAttach(activity);
      this.mContext = activity;
  &#125;

  @Override
  public Context getContext() &#123;
      if (super.getContext() != null) &#123;
          return super.getContext();
      &#125;
      return mContext;
  &#125;</code></pre>
<p>然后尽量调用getContext()方法.</p>
</li>
<li><p>因为<code>getActivity()</code>方法不能重写,所以只好加上判断:</p>
<pre><code>  if(isAdded()) &#123;
      //XXXX
  &#125;</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>如果使用 ViewPager + Fragment, ViewPager 在初始化时会缓存多个 Fragment, 这里可以通过 <code>setUserVisibleHint</code> 来判断 Fragment 是否可见.一个简单封装的 Fragment 如下:</p>
<pre><code> public abstract class BaseFragment extends Fragment &#123;

     //必须有空的构造函数
     public BaseFragment() &#123;

     &#125;

     //避免ViewPager在一开始创建
     private boolean hasLazyLoad = false;

     public void setHasLazyLoad(boolean hasLazyLoad) &#123;
         this.hasLazyLoad = hasLazyLoad;
     &#125;

     /**
      * 懒加载,防止ViewPager重复创建
      */
     protected void onLazyLoad() &#123;

     &#125;

     @Override
     public void setUserVisibleHint(boolean isVisibleToUser) &#123;
         super.setUserVisibleHint(isVisibleToUser);
         if (getUserVisibleHint() &amp;&amp; !hasLazyLoad) &#123;
             onLazyLoad();
             hasLazyLoad = true;
         &#125;
     &#125;

     @Override
     public void onDestroyView() &#123;
         super.onDestroyView();
         hasLazyLoad = false;
     &#125;
 &#125;</code></pre>
<p> 注意需要在 <code>onDestroyView()</code>中复位标志位,因为 ViewPager 的切换会导致 Fragment 的销毁.</p>
</li>
<li><p>在 Fragment 中嵌套 Fragment 时, 最好使用 <code>getChildFragmentManager()</code> 来获取 FragmentManager 示例,同时在 Fragment 销毁时, 利用反射将其置为空. 否则会导致错误 <code>java.lang.IllegalStateException: Activity has been destroyed</code> : </p>
<pre><code> @Override
 public void onDestroyView() &#123;
     super.onDestroyView();

     //解决嵌套 Fragment 的bug
     try &#123;
         Field childFragmentManager = Fragment.class.getDeclaredField(&quot;mChildFragmentManager&quot;);
         childFragmentManager.setAccessible(true);
         childFragmentManager.set(this, null);

     &#125; catch (NoSuchFieldException e) &#123;
         throw new RuntimeException(e);
     &#125; catch (IllegalAccessException e) &#123;
         throw new RuntimeException(e);
     &#125;
 &#125;</code></pre>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/01/23/Android%E5%8A%A8%E6%80%81%E6%9B%BF%E6%8D%A2%E5%9B%BE%E6%A0%87%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/01/23/Android%E5%8A%A8%E6%80%81%E6%9B%BF%E6%8D%A2%E5%9B%BE%E6%A0%87%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Android动态替换图标总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-01-23 19:10:43 / Modified: 19:52:10" itemprop="dateCreated datePublished" datetime="2016-01-23T19:10:43+08:00">2016-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%BC%80%E5%8F%91%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">Android开发经验</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/01/23/Android%E5%8A%A8%E6%80%81%E6%9B%BF%E6%8D%A2%E5%9B%BE%E6%A0%87%E6%80%BB%E7%BB%93/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/23/Android动态替换图标总结/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>现在淘宝,京东等App在节假日打开时,都是采用一套节假日的图标,这种不用发版本,又可以随着后台配置动态替换图标固然是很方便,体验很好的事情.</p>
<h2 id="准备工作-全部按钮的不同状态改为纯图片实现"><a href="#准备工作-全部按钮的不同状态改为纯图片实现" class="headerlink" title="准备工作:全部按钮的不同状态改为纯图片实现."></a>准备工作:全部按钮的不同状态改为纯图片实现.</h2><p>现在很多应用的通知策略都是采用小红点提示,小红点可以单独画出来,与图标分离,单独控制隐藏.但是现在需要动态替换图标,小红点就不能与图片分离了,否则会导致红点位置不理想或红点被图标遮住等问题.为此,所有的状态都需要改为纯图片实现.</p>
<p>首页的tab,目前应用采用的是<code>RadioButton + Fragment</code>的实现,为此,需要自定义RadioButton的selector.</p>
<ol>
<li><p>定义attr.</p>
<pre><code> //下面定义的state_new_message表示有新消息
 &lt;declare-styleable name=&quot;MessageRadioButton&quot;&gt;
     &lt;attr name=&quot;state_new_message&quot; format=&quot;boolean&quot;/&gt;
 &lt;/declare-styleable&gt;</code></pre>
</li>
<li><p>定义selector.</p>
<pre><code> //xxx为你的包名
 //为了配合state_checked,需要4张图片
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
 &lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
     xmlns:message=&quot;http://schemas.android.com/apk/res/xxx&quot;&gt;
     &lt;item android:drawable=&quot;@drawable/icon_union_selected&quot;
         android:state_checked=&quot;true&quot;
         message:state_new_message=&quot;false&quot;/&gt;
     &lt;item android:drawable=&quot;@drawable/icon_union_selected_new&quot;
         android:state_checked=&quot;true&quot;
         message:state_new_message=&quot;true&quot;/&gt;
     &lt;item android:drawable=&quot;@drawable/icon_union_normal&quot; 
         android:state_checked=&quot;false&quot;
         message:state_new_message=&quot;false&quot;/&gt;
     &lt;item android:drawable=&quot;@drawable/icon_union_normal_new&quot; 
         android:state_checked=&quot;false&quot;
         message:state_new_message=&quot;true&quot;/&gt;
 &lt;/selector&gt;</code></pre>
</li>
<li><p>重写RadioButton(ImageView等控件也同样适用).</p>
<pre><code> public class MessageRadioButton extends RadioButton &#123;
     //定义的状态
     private static final int[] STATE_NEW_MESSAGE = &#123;R.attr.state_new_message&#125;;
     //是否有新消息
     private boolean hasNewMessage;

     /**
      * 构造函数
      **/

     /**
      * 关键需要此函数,添加状态
      **/
     @Override
     protected int[] onCreateDrawableState(int extraSpace) &#123;
         if (hasNewMessage) &#123;
             final int[] drawableState = super.onCreateDrawableState(extraSpace + 1);
             mergeDrawableStates(drawableState, STATE_NEW_MESSAGE);
             return drawableState;
         &#125;
         return super.onCreateDrawableState(extraSpace);
     &#125;

     /**
      * 设置是否有新消息数
      * @param newMessage, 是否有新消息数
      */
     public void setHasNewMessage(boolean newMessage) &#123;
         if (hasNewMessage != newMessage) &#123;
             hasNewMessage = newMessage;
             refreshDrawableState();
         &#125;
     &#125;

 &#125;</code></pre>
</li>
</ol>
<p>使用MessageRadioButton的<code>setHasNewMessage()</code>方法即可以显示带小红点的图片.<br>即<strong>所有按钮改为图片实现.</strong></p>
<h2 id="创建Drawable对象"><a href="#创建Drawable对象" class="headerlink" title="创建Drawable对象"></a>创建Drawable对象</h2><p>动态配置就是下载图片成功后,从文件中获取每个按钮的Drawable对象.但是实现时需要注意细节:</p>
<ol>
<li><p>根据图片生成的Drawable对象即<strong>BitmapDrawable</strong>.</p>
<ul>
<li><p>目前BitmapDrawable对应的构造函数未被弃用的还有</p>
<pre><code>  BitmapDrawable(Resources res, Bitmap bitmap)
  BitmapDrawable(Resources res, String path)</code></pre>
<p>  但使用<code>BitmapDrawable(Resources res, String path)</code>时发现在vivo手机上没有生效,所以还是推荐<code>BitmapDrawable(Resources res, Bitmap bitmap)</code>方法.</p>
</li>
<li><p>图片在使用时也需要区分dpi,对应<code>Bitmap.setDensity()</code>方法,参数为160的倍数.</p>
</li>
</ul>
</li>
<li><p>selector对应的Drawable对象即<strong>StateListDrawable</strong>.</p>
<ul>
<li><p><code>StateListDrawable.addState(int[] stateSet, Drawable drawable)</code>方法可以添加状态对应的drawable.</p>
<pre><code>  //state_new_message为false
  listDrawable.addState(new int[]&#123;-R.attr.state_new_message&#125;, drawable);
  //state_new_message为true
  listDrawable.addState(new int[]&#123;R.attr.state_new_message&#125;, drawable);</code></pre>
</li>
<li><p>listDrawable必须调用<code>setBounds()</code>方法才能显示.</p>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://niorgai.github.io/2016/01/13/%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8ViewPager%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jianqiu">
      <meta itemprop="description" content="Android | jianqiu's blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jianqiu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/01/13/%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8ViewPager%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">无限滚动ViewPager的实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-01-13 22:46:22" itemprop="dateCreated datePublished" datetime="2016-01-13T22:46:22+08:00">2016-01-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2018-05-30 12:15:17" itemprop="dateModified" datetime="2018-05-30T12:15:17+08:00">2018-05-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%BC%80%E5%8F%91%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">Android开发经验</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/01/13/%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8ViewPager%E7%9A%84%E5%AE%9E%E7%8E%B0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/无限滚动ViewPager的实现/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Andorid 默认提供的 ViewPager 是不可以循环滚动的, 当滑动到边界时就不能滚动了. 但是实现 Banner 时, 体验最好的还是无限滚动, 为此需要自定义 ViewPager 来实现无限滚动.</p>
<h2 id="PagerAdapter部分"><a href="#PagerAdapter部分" class="headerlink" title="PagerAdapter部分:"></a>PagerAdapter部分:</h2><ol>
<li><p>首先为了实现无限滚动,<code>getCount()</code>需要返回一个很大的数, 比如<code>Integer.MAX_VALUE</code>.</p>
</li>
<li><p>为了节省内存, 默认ViewPager只缓存前后1个Page, 就内存中只有perIndex, currentIndex, nextIndex 三个 View , 实际上也发现只需要三个 View 就可以实现无限滚动.</p>
</li>
<li><p><code>instantiateItem()</code> 方法中, 需要注意的就是获取到 position 对应的 View 后, 如果 <code>view.getParent()</code> 是 container 时, 需要先从 container 中移除该 View , 否则会导致 View 重复添加到 parent 报错.</p>
<pre><code> @Override
 public Object instantiateItem(ViewGroup container, int position) &#123;
     //mView保存了3个View,用于实现轮播.
     //mView[position % 3]即获取该position对应的View
     View view = mViews[position % 3];
     if (container.equals(view.getParent())) &#123;
         //防止添加到同一个parent
         container.removeView(view);
     &#125;
     container.addView(view);
 &#125;</code></pre>
</li>
<li><p>重写 <code>destroyItem()</code> 方法, 什么都不操作, 不调用super方法. 这里之所以自己管理 View 的添加和移除, 是因为源码中是先调用 <code>instantiateItem</code> 添加再调用 <code>destroyItem</code> 移除的, 如果用它的方法, 3个 View 的时候重复添加 parent 就会 crash.</p>
</li>
<li><p><code>isViewFromObject()</code> 方法正常重写即可.</p>
<pre><code> @Override
 public boolean isViewFromObject(View view, Object object) &#123;
     return view == object;
 &#125;</code></pre>
</li>
</ol>
<h2 id="ViewPager部分"><a href="#ViewPager部分" class="headerlink" title="ViewPager部分:"></a>ViewPager部分:</h2><ol>
<li><p>默认 ViewPager 的 Scroller 滑动时间是250ms, 轮播时滑动太快了,所以需要反射 Scroller 来设置合理的滑动时间:</p>
<pre><code> public class MyScroller extends Scroller &#123;
     //默认1秒
     private int mDuration = 1000;

     public MyScroller(Context context) &#123;
         this(context, null);
     &#125;

     public MyScroller(Context context, Interpolator interpolator) &#123;
         super(context, interpolator);
     &#125;

     @Override
     public void startScroll(int startX, int startY, int dx, int dy, int duration) &#123;
         // Ignore received duration, use fixed one instead
         super.startScroll(startX, startY, dx, dy, mDuration);
     &#125;

     @Override
     public void startScroll(int startX, int startY, int dx, int dy) &#123;
         // Ignore received duration, use fixed one instead
         super.startScroll(startX, startY, dx, dy, mDuration);
     &#125;
 &#125;

 //调用以下方法设置
 public void setViewPagerScrollTime() &#123;
     try &#123;
         Field mScroller = ViewPager.class.getDeclaredField(&quot;mScroller&quot;);
         mScroller.setAccessible(true);
         MyScroller scroller = new MyScroller(getContext());
         mScroller.set(this, scroller);
     &#125; catch (Exception e) &#123;
         e.printStackTrace();
     &#125;
 &#125;</code></pre>
</li>
<li><p>注意 ViewPager 的 offset 设为1.</p>
<pre><code> `mViewPager.setOffscreenPageLimit(1);`</code></pre>
</li>
<li><p>在设置 Adapter 或更新数据后, 记得设置 ViewPager 到中间页, 否则往左滑动就会到边界.</p>
<pre><code> //数据大小为size.
 int mid = Integer.MAX_VALUE / 2 - ((Integer.MAX_VALUE / 2) % size);
 holder.mViewPager.setCurrentItem(mid, false);</code></pre>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jianqiu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-niorgai.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
